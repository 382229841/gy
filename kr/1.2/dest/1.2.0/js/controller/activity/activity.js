app.register.controller("activityXrhlController",function($rootScope,$scope,httpRequest,dataStringify,signSha1,analytics,$location){$scope.isShowNavbar=!1,$scope.isApp=isApp($location),$scope.isShowNavbar=$scope.isApp?!1:!0;var link="http://goeasy.yhiker.com/#/activity/xrhl?source=3&sharedTo=",imgUrl="http://goeasy.yhiker.com/image/activity/xrhl/ad.png",title="购轻松韩国",desc="新人尊享，豪华大礼免费领",createNonceStr=function(){return Math.random().toString(36).substr(2,15)},createTimestamp=function(){return parseInt((new Date).getTime()/1e3)+""},raw=function(args){var keys=Object.keys(args);keys=keys.sort();var newArgs={};keys.forEach(function(key){newArgs[key.toLowerCase()]=args[key]});var string="";for(var k in newArgs)string+="&"+k+"="+newArgs[k];return string=string.substr(1)},nonceStr=createNonceStr(),timestamp=createTimestamp(),weixinSdkConfig=function(){$scope.ticket=getWxSdkToken().ticket;var ret={jsapi_ticket:getWxSdkToken().ticket,nonceStr:nonceStr,timestamp:timestamp,url:$location.absUrl().split("#")[0]},string=raw(ret),signature=signSha1(string),config={appId:easybuy.weixinAppId,timestamp:timestamp,nonceStr:nonceStr,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"],signature:signature};$(document).ready(function(){wx.config(config),wx.ready(function(){wx.onMenuShareTimeline({title:desc,link:link+"1",imgUrl:imgUrl,success:function(){$scope.fadeOutShare();{var tokenInfo=getToken();"platform=all&token="+tokenInfo.token}},cancel:function(){$scope.fadeOutShare()}}),wx.onMenuShareAppMessage({title:title,desc:desc,link:link+"2",imgUrl:imgUrl,type:"link",dataUrl:"",success:function(){$scope.fadeOutShare(),alertWarning("发送成功！")},cancel:function(){}})}),wx.error(function(res){alertWarning(JSON.stringify(res))})})};if(easybuy.isWechat)if(!getWxSdkToken()||getWxSdkToken()&&!getWxSdkToken().ticket){var data="platform=all";httpRequest.APIPOST("/wx/data?platform=all",null,{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var data=result.result;setWxSdkToken({accessToken:data.access_token,ticket:data.ticket}),weixinSdkConfig()}else alert(result.msg)})}else weixinSdkConfig();if($scope.goTo=function(type,action){var tokenInfo=getToken(),isLogin=!1;if(tokenInfo&&tokenInfo.token&&(isLogin=!0),$scope.isApp)window.location.href=easybuy.appActivity+"?action="+action;else if(1==type){if(!isLogin)return void redirectLogin($location,"activity-xrhl");$scope.getCoupons(tokenInfo.token)}else if("myCoupon"==type){if(!isLogin)return void openDialog("您还没登录呢！",null,["确定"]);$scope.getCashCoupons(tokenInfo.token,type)}else $location.path("/"+type)},$scope.getCoupons=function(token){var data="platform=all&token="+token;httpRequest.APIPOST("/user/getCoupons",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var msg=result.msg;alertWarning("恭喜您领取成功！")}else{var msg=result.msg;openDialog(msg,null,["确定"])}})},$scope.getCashCoupons=function(token,path){var data="platform=all&token="+token;httpRequest.APIPOST("/user/checkCoupons",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var msg=result.msg;$location.path("/"+path).search({from:"activity"})}else{var msg=result.msg;openDialog(msg,null,["确定"])}})},$location.search()&&$location.search().nickname&&$location.search().timestamp&&$location.search().version&&$scope.getCoupons($location.search().token),$scope.shareToFriends=function(){if($scope.isApp)return void(window.location.href=easybuy.appActivity+"?action=3&shareTitle="+title+"&shareText="+desc+"&shareUrl="+link+"&shareImageUrl="+imgUrl+"&title=【糖村】新年好礼！");if(easybuy.isWechat){var tokenInfo=getToken();tokenInfo&&tokenInfo.token&&tokenInfo.openId?$scope.fadeInShare():$location.path("/wechatOauth/activity-activityDetail")}else{var arrButton=["确定"];openDialog("请在微信内打开并分享到朋友圈","",arrButton,null,function(r){})}},$scope.shareSuccess=function(){},$scope.back=function(){$location.path("/products")},$scope.fadeOutShare=function(){$("#shareHint").fadeOut()},$scope.fadeInShare=function(){$("#shareHint").fadeIn()},$location.search()&&$location.search().activityId){var actId="";actId=$location.search().activityId instanceof Array?$location.search().activityId[0]:$location.search().activityId;var data="platform=all&activityId="+actId;httpRequest.APIPOST("/activity/detail",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){if($scope.activityInfo=result.result,null==result.result)return void alertExt("该活动已结束，更多精彩活动尽在首页！",function(){$location.path("/"),$scope.$apply($location)});var act=$scope.activityInfo.activity;link=act.url.indexOf("?")>0?act.url+"&activityId="+act.id+"&source=3&sharedTo=":act.url+"?activityId="+act.id+"&source=3&sharedTo=",imgUrl=act.img,title=act.name,desc=act.desc}else alert(result.msg)})}if($location.search()&&$location.search().sharedTo&&$location.search().source){var actId=($location.search(),""),channel=$location.search().sharedTo||1;channel instanceof Array&&(channel=1);{var platform=$location.search().source||"all";$location.search().pageType||""}platform=1==platform?"android":2==platform?"ios":"all",actId=$location.search().activityId instanceof Array?$location.search().activityId[0]:$location.search().activityId;var token="";getToken()&&(token="&token="+getToken().token);var data="activityId="+actId+"&channel="+channel+"&platform="+platform+token;httpRequest.APIPOST("/activity/clickLog",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success})}else{var platform=$location.search().platform||"all",token=$location.search().token||"",actId="";actId=$location.search().activityId instanceof Array?$location.search().activityId[0]:$location.search().activityId,token?token="&token="+token:getToken()&&(token="&token="+getToken().token);var data="activityId="+actId+"&type=2&platform="+platform+token;httpRequest.APIPOST("/activity/clickLog",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success})}});