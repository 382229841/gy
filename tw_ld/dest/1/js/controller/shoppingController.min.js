app.controller("navbarController",function($rootScope,$scope){$scope.back=function(){history.back()}}),app.controller("productListController",function($rootScope,$templateCache,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){var code=$routeParams.code||0;$scope.isSearchPage=!1,$scope.showSearch=function(){$scope.isSearchPage=!0,$("#searchPage").addClass("current")},$rootScope.categoryId=code,$scope.code=code,$scope.user=getToken();var loadObj=new loadControl("#myLoadCanvas",function(){$(".pull-loading").html("加载中..."),$scope.pageNum++,appendGoods($scope.pageNum)}),getCategories=function(){var cat=$rootScope.categories;cat&&cat.length?($scope.categories=cat,$rootScope.initNav(cat)):httpRequest.APIPOST("/goods/category_v1.3",dataStringify("platform=all"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var cat=result.result;$scope.categories=cat,$rootScope.initNav(cat)}else alertWarning(result.msg)})},appendGoods=function(pageNum){var now=(new Date).format("yyyy-mm-dd HH:MM:ss");$scope.isloading=!0;var paramCategory=code?"&category="+code:"",ldToken=$scope.user?"&token="+$scope.user.token:"";httpRequest.APIPOST("/goods/listByCategory",dataStringify("platform=all"+ldToken+paramCategory+"&pageNo="+pageNum+"&pageSize=10&now="+now),{"content-type":"application/x-www-form-urlencoded"},1==pageNum?!0:!1).then(function(result){result&&result.code==statusCode.Success?(pageNum>1?($scope.products=$scope.products.concat(result.result),$scope.pageCount=result.page.totalPage,$scope.pageNum=pageNum):($scope.products=result.result,$scope.pageCount=result.page.totalPage,$scope.pageNum=result.page.pageNo),$scope.isloading=!1):($scope.isloading=!1,alertWarning(result.msg))})};getCategories(),appendGoods(1),$(".scrollable-content").scroll(function(){$("#divProducts").length>0&&0==$scope.isloading&&$scope.pageCount&&advanceLoad("#divProductList",loadObj,$scope.pageNum<$scope.pageCount)}),$scope.inquiry=function(){$location.path("/myProfile")}}),app.controller("cartNumController",function($rootScope,$scope,analytics,$location){$scope.cart=function(){$location.path("/cart")},$scope.cartNum=function(){return getCartNum()}}),app.controller("productAppController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.$on("CtrlDownloadShow",function(event,show){$scope.showDownload=show}),$scope.isGo=function(){return!1},httpRequest.APIPOST("/goods/detail",dataStringify("platform=all&id="+$routeParams.id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success&&($scope.product=result.result,$scope.product)){if($scope.product.num=1,$scope.product.imgs&&$scope.product.imgs.length>0){$(".pager_control").removeClass("hide"),1==$scope.product.favorite&&$(".div-favorite img").attr("src","image/icon_favorite_hover.png"),$(".product-content").html($scope.product.description),$(".product-content").find("img").unbind("click").bind("click",function(){showImageLarger(this)});var control=navigator.control||{};control.gesture&&control.gesture(!1),$scope.product.avgStar=$scope.product.avgStar?$scope.product.avgStar:0,$scope.product.commentNum>0&&($(".rateTotal").raty({path:"image/raty",size:15,score:$scope.product.avgStar,readOnly:!0}),$(".itemRate").raty({path:"image/raty",size:15,score:$scope.product.comment.star,readOnly:!0}))}"undefined"==typeof IScroll?$.ajax({url:"/lib/iscroll.js",dataType:"script",cache:!0,success:function(){$scope.initScroll()}}):$scope.initScroll()}}),$scope.back=function(){1==history.length||$location.search().version?$location.path("/products"):history.back()},$scope.addToCart=function(goodsNum){return 0>=goodsNum?void alertWarning("库存已不足，请稍后购买"):($(".promotePriceNewTotal").html("￥"+$scope.product.promotePrice),void openPrompt("addToCart",function(num){var product=$.extend(!0,{},$scope.product);product.num=num,addToCart(product),$scope.$apply($scope.$$childHead),closeDialog(),alertSuccess("加入成功")}))},$scope.reduceNum=function(goods){goods.num>1&&goods.num--},$scope.addNum=function(goods){goods.num++},$scope.validNum=function(goods,allowEmpty){if(goods.num=validInteger(goods.num),!allowEmpty||""!=goods.num){var num=parseInt(goods.num);goods.num=isNaN(num)||1>num?1:num}},$scope.go=function(goodsNum){if(0>=goodsNum)return void alertWarning("库存已不足，请稍后购买");var user=$location.$$search,currentUser=getToken();if(user&&user.openId||currentUser&&currentUser.token)if(!currentUser||currentUser&&!currentUser.token){var source=user.source,data="platform=all&openid="+user.openId+"&nickname="+user.nickname+"&gender=0&avatar="+user.headimgurl+"&source="+source+"&channel=H5&appVersion="+easybuy.version;httpRequest.APIPOST("/user/thirdLogin",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){$scope.user=result.result,$scope.user.openId=user.openId,$scope.user.source=user.source,$scope.user.nickname=user.nickname,$scope.user.headimgurl=user.headimgurl,null==$scope.user.mobile&&($scope.user.mobile="0"),setToken($scope.user);var urlUser=$scope.user;openPrompt("go",function(num){var product=$.extend(!0,{},$scope.product);if(product.num=num,$scope.product){removeOrder(),setOrder([product]);var goodsArr=new Array,goods=new Object;goods.id=product.id,goods.num=product.num,goodsArr.push(goods),closeDialog(),$location.path("/pay/999").search({area:1,goods:JSON.stringify([product]),user:JSON.stringify(urlUser)}),$scope.$apply($location)}})}else alert(result.msg)})}else{var urlUser={};urlUser=currentUser&&currentUser.token?currentUser:user,openPrompt("go",function(num){var product=$.extend(!0,{},$scope.product);if(product.num=num,$scope.product){removeOrder(),setOrder([product]);var goodsArr=new Array,goods=new Object;goods.id=product.id,goods.num=product.num,goodsArr.push(goods),closeDialog(),$location.path("/pay/999").search({area:1,goods:JSON.stringify([product]),user:JSON.stringify(urlUser)}),$scope.$apply($location)}})}else $location.path(easybuy.isWechat?"/wechatOauth/product-"+$routeParams.id:"/myProfile/product-"+$routeParams.id)},$scope.viewComments=function(){$scope.product&&$scope.product.commentNum>0&&$location.path("/comment/"+$routeParams.id)},$scope.initScroll=function(){for(var i=0;i<$scope.product.imgs.length;i++){var img=$scope.product.imgs[i],p=$scope.product,$img=$("<img />");$img.attr("src",img),$img.attr("title",p.title);var $slide=$('<div class="slide"></div>').append($img);$("#scroller").append($slide),$("#indicator").css("width",15*$scope.product.imgs.length-5+"px"),$(".slide").css("width",100/$scope.product.imgs.length+"%"),$("#scroller").css("width",100*$scope.product.imgs.length+"%")}$("#spanCurrPage").html(1),$("#spanTotalsCount").html($scope.product.imgs.length),$scope.myScroll=null,$scope.myScroll=new IScroll("#wrapper",{scrollX:!0,scrollY:!1,momentum:!1,preventDefault:!1,snap:!0,snapSpeed:100,keyBindings:!0,indicators:{el:document.getElementById("indicator"),resize:!1}});var handler=function(e){e.preventDefault()};$scope.myScroll.on("scrollStart",function(){$("#viewport")[0].addEventListener("touchmove",handler,!1)}),$scope.myScroll.on("scrollEnd",function(){$("#spanCurrPage").html($scope.myScroll.currentPage.pageX+1),$("#viewport")[0].removeEventListener("touchmove",handler,!1)})}}),app.controller("commentController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){function appendComments(pageNum){$scope.isloading=!0,httpRequest.APIPOST("/goods/listComment",dataStringify("platform=all&goodsId="+$routeParams.id+"&pageNo="+pageNum+"&pageSize=15"+(pageNum>1?"&now="+$scope.pageTime:"")),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if($scope.isloading=!1,result&&result.code==statusCode.Success){$scope.commentInfo=result.result,$scope.page=result.page,$scope.commentInfo&&$(".rateTotal img").length<1&&$(".rateTotal").raty({path:"image/raty",size:15,score:$scope.commentInfo.avgStar,readOnly:!0});var comments=$scope.commentInfo.comments;if(comments){var index=0;$scope.comments?(index=$scope.comments.length,$scope.comments=$scope.comments.concat(comments)):$scope.comments=comments,setTimeout(function(){$scope.$apply($scope.comments),$.each($(".product-item-comment"),function(i,item){$(item).find(".itemRate img").length<1&&$(item).find(".itemRate").raty({path:"image/raty",size:15,score:parseInt($(item).find(".itemRate").attr("score")),readOnly:!0})})},0)}}loadObj.clear(),$(".pull-loading").html("上拉加载")})}$scope.pageNum=1,appendComments($scope.pageNum);var loadObj=new loadControl("#myLoadCanvas",function(){$(".pull-loading").html("加载中..."),$scope.pageNum++,appendComments($scope.pageNum)});$(".scrollable-content").scroll(function(){$("#divProductComments").length>0&&0==$scope.isloading&&$scope.page&&advanceLoadCommon("#divProductComments",loadObj,$scope.pageNum<$scope.page.totalPage)})}),app.controller("downloadController",function($rootScope,$scope,httpRequest,analytics,$location,$window,$routeParams){$scope.type=$routeParams.type,$scope.ProgramTypes=easybuy.ProgramTypes,$scope.mobileType=getMobileType(),$scope.type==$scope.ProgramTypes.APP||getCloseDownloadApp()||($scope.mobileType==MobileTypes.Android&&appDownloadUrl.android&&""!=appDownloadUrl.android?(!isWeixin()||appDownloadUrl.webchat&&""!=appDownloadUrl.webchat)&&($scope.show=!0):($scope.mobileType==MobileTypes.iPhone||$scope.mobileType==MobileTypes.iPad)&&appDownloadUrl.ios&&""!=appDownloadUrl.ios&&(!isWeixin()||appDownloadUrl.webchat&&""!=appDownloadUrl.webchat)&&($scope.show=!0)),$scope.$emit("CtrlDownloadShow",$scope.show);var isXiaoMiBrowser=function(){var ua=navigator.userAgent.toLowerCase();return"miuibrowser"==ua.match(/miuibrowser/i)?!0:!1};$scope.download=function(){isWeibo()||(window.location.href=easybuy.appOpenUrl),$scope.mobileType==MobileTypes.Android&&isXiaoMiBrowser()&&(window.location.href=appDownloadUrl.webchat),window.setTimeout(function(){if(isWeixin()){if($scope.mobileType==MobileTypes.Android)window.location.href=appDownloadUrl.webchat;else if($scope.mobileType==MobileTypes.iPhone||$scope.mobileType==MobileTypes.iPad){$scope.mobileType==MobileTypes.iPad;var arrButton=["取消","确定"];openDialog("请点击右上角在浏览器中打开下载","",arrButton,null,function(r){})}}else $scope.mobileType==MobileTypes.Android?window.location.href=isXiaoMiBrowser()?appDownloadUrl.android:appDownloadUrl.webchat:($scope.mobileType==MobileTypes.iPhone||$scope.mobileType==MobileTypes.iPad)&&($scope.mobileType==MobileTypes.iPad?window.open(appDownloadUrl.ios):window.location.href=appDownloadUrl.ios)},500)},$scope.close=function(){$scope.show=!1,setCloseDownloadApp(),$scope.$emit("CtrlDownloadShow",$scope.show)}}),app.controller("cartController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){$scope.products=[],$scope.empty=!1;var cartProducts=getCart();if($scope.totalAmountValue=0,cartProducts&&cartProducts.length>0){for(var length=cartProducts.length,goodsId="",quantity="",checkeds="",i=0;length>i;i++){var chk=cartProducts[i].checked?"1":"0";length-1>i?(goodsId=goodsId+cartProducts[i].id+",",quantity=quantity+cartProducts[i].num+",",checkeds=checkeds+chk+","):(goodsId+=cartProducts[i].id,quantity+=cartProducts[i].num,checkeds+=chk)}httpRequest.APIPOST("/cart/group",dataStringify("platform=all&goodsId="+goodsId+"&quantity="+quantity+"&checked="+checkeds),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){$scope.products=result.result.tw.concat(result.result.ch);var tempCartProducts=[];if($scope.products)for(var i=0;i<$scope.products.length;i++)for(var j=0;j<$scope.products[i].goodsList.length;j++)$scope.products[i].goodsList[j].checked=$scope.products[i].goodsList[j].checked?!0:!1,tempCartProducts.push({id:$scope.products[i].goodsList[j].id,num:$scope.products[i].goodsList[j].quantity,checked:$scope.products[i].goodsList[j].checked});setCart(0==tempCartProducts.length?null:tempCartProducts),$scope.empty=$scope.products?!1:!0,$scope.products&&$scope.products.length>0&&($scope.isAllChecked(),$scope.totalAmount())}else alertWarning(result.msg)})}else $scope.empty=!0;(getMobileType()==MobileTypes.iPhone||getMobileType()==MobileTypes.iPad)&&(window.onresize=function(){refixNavBottom()},window.onresize()),$scope.reduceNum=function(product,p,parentIndex,index){product.quantity>1&&(product.quantity--,product.checked=!0,setProductsNumInCart($scope.products),$scope.totalAmount(parentIndex,index))},$scope.addNum=function(product,p,parentIndex,index){product.quantity++,product.checked=!0,setProductsNumInCart($scope.products),$scope.totalAmount(parentIndex,index)},$scope.validNum=function(product,allowEmpty,parentIndex,index){if(product.quantity=validInteger(product.quantity),!allowEmpty||""!=product.quantity){var num=parseInt(product.quantity);product.quantity=isNaN(num)||1>num?1:num,product.checked=!0,setProductsNumInCart($scope.products),$scope.totalAmount(parentIndex,index)}},$scope.checked=function(product,parentIndex,index){product.checked=product.checked?!1:!0,setProductsNumInCart($scope.products),$scope.totalAmount(parentIndex,index)},$scope.totalNum=function(){var totalNum=0;if($scope.products)for(var i=0;i<$scope.products.length;i++)for(var j=0;j<$scope.products[i].goodsList.length;j++)$scope.products[i].goodsList[j].checked&&(totalNum+=$scope.products[i].goodsList[j].quantity);return totalNum},$scope.isAllChecked=function(){if(null==$scope.products||0==$scope.products.length)return!1;for(var i=0;i<$scope.products.length;i++)for(var j=0;j<$scope.products[i].goodsList.length;j++)if(null==$scope.products[i].goodsList[j].checked||!$scope.products[i].goodsList[j].checked)return!1;return!0},$scope.checkAll=function(){if($scope.products&&$scope.products.length>0){for(var isAllChecked=$scope.isAllChecked(),i=0;i<$scope.products.length;i++)for(var j=0;j<$scope.products[i].goodsList.length;j++)$scope.products[i].goodsList[j].checked=!isAllChecked;setProductsNumInCart($scope.products),$scope.getLocalCart()}},$scope.go=function(){if(0==$scope.totalNum())return void alertWarning("您还没有选择商品哦");var user=$location.$$search,currentUser=getToken();if(user&&user.openId||currentUser&&currentUser.token)if(!currentUser||currentUser&&!currentUser.token){var source=user.source,data="platform=all&openid="+user.openId+"&nickname="+user.nickname+"&gender=0&avatar="+user.headimgurl+"&source="+source+"&channel=H5&appVersion="+easybuy.version;httpRequest.APIPOST("/user/thirdLogin",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){$scope.user=result.result,$scope.user.openId=user.openId,$scope.user.source=user.source,$scope.user.nickname=user.nickname,$scope.user.headimgurl=user.headimgurl,null==$scope.user.mobile&&($scope.user.mobile="0"),setToken($scope.user);var urlUser=$scope.user,goodsArr=new Array;$.each(currentProducts,function(i,product){for(var j=0;j<product.goodsList.length;j++)if(product.goodsList[j].checked){var goods=new Object;goods.id=product.goodsList[j].id,goods.num=product.goodsList[j].quantity,goodsArr.push(goods)}}),$location.path("/pay/999/1").search({area:1,goods:JSON.stringify($scope.products),user:JSON.stringify(urlUser)}),$scope.$apply($location)}else alert(result.msg)})}else{var urlUser={};urlUser=currentUser&&currentUser.token?currentUser:user;var goodsArr=new Array;$.each($scope.products,function(i,product){for(var j=0;j<product.goodsList.length;j++)if(product.goodsList[j].checked){var goods=new Object;goods.id=product.goodsList[j].id,goods.num=product.goodsList[j].quantity,goodsArr.push(goods)}}),$location.path("/pay/999/1").search({area:1,goods:JSON.stringify($scope.products),user:JSON.stringify(urlUser)})}else $location.path(easybuy.isWechat?"/wechatOauth/cart":"/myProfile/cart")},$scope.edit=function(){$scope.editMode=!0},$scope.done=function(){$scope.editMode=!1,$scope.totalAmount()},$scope.remove=function(){if(0==$scope.totalNum())return void alertWarning("请选中您要删除的商品");var arrButton=["取消","确定"];openDialog("确认从购物袋中删除所有选中的商品？","删除商品",arrButton,null,function(r){if(r){if($scope.products){for(var i=$scope.products.length-1;i>=0;i--)for(var j=$scope.products[i].goodsList.length-1;j>=0;j--)$scope.products[i].goodsList[j].checked&&$scope.products[i].goodsList.splice(j,1);$scope.$apply($scope.products);for(var cartProductsTemp=[],i=0;i<$scope.products.length;i++)for(var j=0;j<$scope.products[i].goodsList.length;j++){var cartProductTemp={};cartProductTemp.id=$scope.products[i].goodsList[j].id,cartProductTemp.num=$scope.products[i].goodsList[j].quantity,cartProductTemp.checked=$scope.products[i].goodsList[j].checked,cartProductsTemp.push(cartProductTemp)}}if($scope.products)for(var i=0;i<$scope.products.length;i++)for(var j=0;j<$scope.products[i].goodsList.length;j++){var cartProductTemp={};cartProductTemp.id=$scope.products[i].goodsList[j].id,cartProductTemp.num=$scope.products[i].goodsList[j].quantity,cartProductTemp.checked=$scope.products[i].goodsList[j].checked,cartProductsTemp.push(cartProductTemp)}setCart(cartProductsTemp),0==cartProductsTemp.length&&$scope.$apply($scope.empty=!0),$scope.$apply($scope.products)}})},$scope.totalAmount=function(parentIndex){$scope.totalAmountValue=0;var cartProducts=$scope.products;if(cartProducts&&cartProducts.length>0){for(var length=cartProducts.length,goodsId="",quantity="",i=0;length>i;i++)$scope.totalAmountValue=$scope.totalAmountValue+parseFloat(cartProducts[i].total);var isXJZero=!0;if(void 0!=parentIndex)for(var i=0;i<cartProducts[parentIndex].goodsList.length;i++)cartProducts[parentIndex].goodsList[i].checked&&(isXJZero=!1,i<cartProducts[parentIndex].goodsList.length-1?(goodsId=goodsId+cartProducts[parentIndex].goodsList[i].id+",",quantity=quantity+cartProducts[parentIndex].goodsList[i].quantity+","):(goodsId+=cartProducts[parentIndex].goodsList[i].id,quantity+=cartProducts[parentIndex].goodsList[i].quantity));if(!goodsId||goodsId.length<1)return void(void 0!=parentIndex&&($scope.products[parentIndex].js="0.00",$scope.products[parentIndex].total="0.00"));httpRequest.APIPOST("/cart/price",dataStringify("platform=all&goodsId="+goodsId+"&quantity="+quantity),{"content-type":"application/x-www-form-urlencoded"},!0).then(function(result){if(result&&result.code==statusCode.Success){$scope.totalAmountValue=0,isXJZero?($scope.products[parentIndex].js="0.00",$scope.products[parentIndex].total="0.00"):($scope.products[parentIndex].js=result.result.js,$scope.products[parentIndex].total=result.result.xj);for(var i=0;length>i;i++)$scope.totalAmountValue=$scope.totalAmountValue+parseFloat(cartProducts[i].total)}else alert(result.msg)})}},$scope.getLocalCart=function(){var products=$scope.products,cartProducts=[];if($scope.totalAmountValue=0,products&&products.length>0){for(var i=0;i<products.length;i++)for(var j=0;j<products[i].goodsList.length;j++)cartProducts.push(products[i].goodsList[j]);for(var length=cartProducts.length,goodsId="",quantity="",checkeds="",i=0;length>i;i++){var chk=cartProducts[i].checked?"1":"0";length-1>i?(goodsId=goodsId+cartProducts[i].id+",",quantity=quantity+cartProducts[i].quantity+",",checkeds=checkeds+chk+","):(goodsId+=cartProducts[i].id,quantity+=cartProducts[i].quantity,checkeds+=chk)}httpRequest.APIPOST("/cart/local",dataStringify("platform=all&goodsId="+goodsId+"&quantity="+quantity+"&checked="+checkeds),{"content-type":"application/x-www-form-urlencoded"},!0).then(function(result){if(result&&result.code==statusCode.Success)if($scope.products=result.result,$scope.products){for(var i=0;i<$scope.products.length;i++)for(var j=0;j<$scope.products[i].goodsList.length;j++)$scope.products[i].goodsList[j].checked=$scope.products[i].goodsList[j].checked?!0:!1;$scope.isAllChecked(),$scope.totalAmount()}else $scope.empty=!0;else alert(result.msg)})}else $scope.empty=!0}}),app.controller("addressController",function($rootScope,$scope,dataStringify,httpRequest,analytics,$location,$window,$routeParams){function initArea(){$("#agentRegion").val($scope.addressInfo.region).attr("data",$scope.addressInfo.regionIds),$("#pAddress").mobiscroll().treelist({theme:"android-ics light",display:"modal",mode:"scroller",labels:["省份","城市"],setText:"确认",cancelText:"取消",width:"90",insertTo:"#agentRegion",action:"fillParentCity"}),$("#pAddress_dummy").css("display","none"),$("#agentRegion").click(function(){return $("#pAddress_dummy").click(),!1})}if($scope.buyType=parseInt($routeParams.buyType)||1,$location.$$search.token)showLoading(),httpRequest.APIPOST("/address/default",dataStringify("platform=all&token="+$location.$$search.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg)if($scope.addressInfo=result.result,$scope.addressInfo&&$scope.addressInfo.returnDate&&($scope.time=$scope.addressInfo.returnDate+" "+$scope.addressInfo.returnTime),$scope.addressInfo?$scope.addressInfo.province&&($scope.addressInfo.region=$scope.addressInfo.province+" "+$scope.addressInfo.city+" "+$scope.addressInfo.district,$scope.addressInfo.regionIds=$scope.addressInfo.provinceId+","+$scope.addressInfo.cityId+","+$scope.addressInfo.districtId):$scope.addressInfo={},2==$scope.buyType)initArea();else{setAddressTemp($scope.addressInfo);var startdate=new Date;startdate.setHours(startdate.getHours()+1);var m=startdate.getMinutes()%5;0!=m&&startdate.setMinutes(startdate.getMinutes()+(5-m)),startdate.setSeconds(0),startdate.setMilliseconds(0),$scope.minDateTime=startdate;var enddate=new Date;enddate.setMonth(enddate.getMonth()+6),enddate.setHours(23),enddate.setMinutes(59),enddate.setSeconds(59),enddate.setMilliseconds(999),$scope.maxDateTime=enddate,opt.datetime={dateOrder:"yymmdd",dateFormat:"yyyy-mm-dd",preset:"datetime",minDate:startdate,maxDate:enddate,stepMinute:5,onSelect:function(){$scope.saveTemp(),$scope.time=$("#appDateTime").val(),event.stopPropagation()}};{var optDateTime=$.extend(opt.datetime,opt.Default);$.extend(opt.time,opt.Default)}$("#appDateTime").mobiscroll(optDateTime).date(optDateTime)}else alertWarning(result.msg)});else if(2==$scope.buyType)initArea();else{var startdate=new Date;startdate.setHours(startdate.getHours()+1);var m=startdate.getMinutes()%5;0!=m&&startdate.setMinutes(startdate.getMinutes()+(5-m)),startdate.setSeconds(0),startdate.setMilliseconds(0),$scope.minDateTime=startdate;var enddate=new Date;enddate.setMonth(enddate.getMonth()+6),enddate.setHours(23),enddate.setMinutes(59),enddate.setSeconds(59),enddate.setMilliseconds(999),$scope.maxDateTime=enddate,opt.datetime={dateOrder:"yymmdd",dateFormat:"yyyy-mm-dd",preset:"datetime",minDate:startdate,maxDate:enddate,stepMinute:5,onSelect:function(){$scope.saveTemp(),$scope.time=$("#appDateTime").val(),$scope.search(),event.stopPropagation()}};{var optDateTime=$.extend(opt.datetime,opt.Default);$.extend(opt.time,opt.Default)}$("#appDateTime").mobiscroll(optDateTime).date(optDateTime)}$scope.back=function(){clearAddressTemp(),history.back()},$scope.date=function(){$("#appDateTime").mobiscroll("show")},$scope.validNum=function(){$scope.addressInfo.mobile=validInteger($scope.addressInfo.mobile)},$scope.saveTemp=function(){$scope.addressInfo||($scope.addressInfo={}),2==$scope.buyType?($scope.addressInfo.region=$("#agentRegion").val(),$scope.addressInfo.regionIds=$("#agentRegion").attr("data")):$scope.addressInfo.returnTime=$("#appDateTime").val(),setAddressTemp($scope.addressInfo)},$scope.search=function(callback){var flightNo=$scope.addressInfo.returnFlightno;if(void 0==flightNo&&(flightNo=""),flightNo.length>=2&&$scope.time){var data="platform=all&backFlightno="+flightNo+"&backDate="+$scope.time;httpRequest.APIPOST("/flight/back",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.addressInfo.returnAirportId=result.result.returnAirportId,$scope.addressInfo.returnAirport=result.result.returnAirport,$scope.addressInfo.returnTime=result.result.returnTime,$scope.time||($scope.time=""),$("#appDateTime").val($scope.time.split(" ")[0]+" "+result.result.returnTime),$scope.time=$scope.time.split(" ")[0]+" "+result.result.returnTime,$scope.saveTemp(),callback()):($scope.addressInfo.returnAirportId=-1,$scope.addressInfo.returnAirport="",alertWarning(result.msg))})}},$scope.save=function(){if(1==$scope.buyType){if(!$scope.addressInfo.contact||""==$scope.addressInfo.contact.toString().trim())return void alertWarning("请填写联系人姓名");if($scope.addressInfo.contact.toString().length<2||$scope.addressInfo.contact.toString().length>20)return void alertWarning("请输入2~20位的联系人姓名");if(!$scope.addressInfo.mobile||""==$scope.addressInfo.mobile)return void alertWarning("请填写手机号码");if($scope.addressInfo.mobile.toString().length<9||$scope.addressInfo.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");var flightTime=$("#appDateTime").val();if(!flightTime||""==flightTime)return void alertWarning("请选择回程日期");if($scope.addressInfo.returnTime=flightTime,!$scope.addressInfo.returnFlightno||""==$scope.addressInfo.returnFlightno)return void alertWarning("请输入回程航班号");if(new Date(flightTime.replace(/-/g,"/"))<$scope.minDateTime)return void alertWarning("起飞时间请选择1小时后")}else{if(!$scope.addressInfo.contact||""==$scope.addressInfo.contact.toString().trim())return void alertWarning("请填写收货人姓名");if($scope.addressInfo.contact.toString().length<2||$scope.addressInfo.contact.toString().length>20)return void alertWarning("请输入2~20位的收货人姓名");if(!$scope.addressInfo.mobile||""==$scope.addressInfo.mobile)return void alertWarning("请填写手机号码");if($scope.addressInfo.mobile.toString().length<9||$scope.addressInfo.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");if(0==$("#agentRegion").val().trim().length)return void alertWarning("请选择所在地");if($scope.addressInfo.region=$("#agentRegion").val(),!$scope.addressInfo.detailAddress||""==$scope.addressInfo.detailAddress.toString().trim())return void alertWarning("请填写详细地址");if($scope.addressInfo.detailAddress.toString().length<5||$scope.addressInfo.detailAddress.toString().length>60)return void alertWarning("请输入5~60位的收货地址")}$scope.search(function(){var data="";if(2==$scope.buyType){var arrRegion=$("#agentRegion").attr("data").split(",");data="platform=all&token="+$location.$$search.token+"&contact="+$scope.addressInfo.contact+"&cityId="+arrRegion[1]+"&detailAddress="+$scope.addressInfo.detailAddress+"&provinceId="+arrRegion[0]+"&districtId="+arrRegion[2]+"&mobile="+$scope.addressInfo.mobile}else data="platform=all&token="+$location.$$search.token+"&returnTime="+$scope.addressInfo.returnTime+"&contact="+$scope.addressInfo.contact+"&returnAirportId="+$scope.addressInfo.returnAirportId+"&mobile="+$scope.addressInfo.mobile+"&returnFlightno="+$scope.addressInfo.returnFlightno;httpRequest.APIPOST("/address/add",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(clearAddressTemp(),history.back()):alertWarning(result.msg)})})}}),app.controller("airportController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){httpRequest.APIPOST("/dic/listFlight",dataStringify("platform=all&type=2"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){var flights=result.result;$scope.flights=[];for(var i=0;i<flights.length;i++)$scope.flights.push({id:flights[i].id,terminal:flights[i].name});if($scope.flights&&null!=$routeParams.id)for(var i=0;i<$scope.flights.length;i++)if($scope.flights[i].id==$routeParams.id){$scope.flights[i].selected=!0;break}}else alertWarning(result.msg)}),$scope.select=function(flight){if($scope.flights&&$scope.flights.length>0)for(var i=0;i<$scope.flights.length;i++)$scope.flights[i].selected=!1;flight.selected=!0;var addressInfo=getAddressTemp();null==addressInfo&&(addressInfo=new Object),addressInfo.flight_id=flight.id,addressInfo.terminal=flight.terminal,setAddressTemp(addressInfo),history.back()},$scope.isSelected=function(){if($scope.flights&&$scope.flights.length>0)for(var i=0;i<$scope.flights.length;i++)if($scope.flights[i].selected)return!0;return!1}}),app.controller("orderInquiryController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){if(easybuy.parameter.mobileInquiry&&($scope.mobile=easybuy.parameter.mobileInquiry),!$scope.mobile){var userInfo=getUserInfo();userInfo&&($scope.mobile=userInfo.mobile)}$scope.validNum=function(){$scope.mobile=validInteger($scope.mobile)},$scope.inquiry=function(){return $scope.mobile&&""!=$scope.mobile?$scope.mobile.toString().length<9||$scope.mobile.toString().length>13?void alertWarning("请输入9~13位的手机号"):(easybuy.parameter.mobileInquiry=$scope.mobile,void $location.path("/orderList/"+$scope.mobile)):void alertWarning("请填写手机号")}}),app.controller("orderListController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){if($scope.token=$routeParams.token,easybuy.isWechat&&!$scope.token){if(!getToken()||!getToken().token)return void $location.path("/wechatOauth/orderList");$scope.token=getToken().token}$scope.orders=[],$scope.go=function(){$location.path("/products")},$scope.getOrderStatus=function(status,category){return 1==status?"等待付款":2==status&&category&&3==category?"进行中":2==status&&3!=category?"等待确认收货":3==status&&category&&3==category?"交易成功":3==status&&3!=category?"交易成功":4==status?"订单已取消":5==status&&3!=category?"退款中":6==status&&3!=category?"退款成功":7==status?"已失效":void 0};var tokenInfo=getToken();tokenInfo&&tokenInfo.token||(tokenInfo={},tokenInfo.token="");var pageNo=1,pageSize=100,token=$scope.token?$scope.token:tokenInfo.token;showLoading(),httpRequest.APIPOST("/order/list",dataStringify("platform=all&token="+token+"&category=1&pageNo="+pageNo+"&pageSize="+pageSize),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?($scope.orders=result.result,hideLoading(),$scope.orders&&$scope.orders.length<1&&($scope.orders=null)):(hideLoading(),alert(result.msg))}),$scope.Payments=easybuy.Payments;for(var isChecked=!1,i=$scope.Payments.length-1;i>=0;i--)$scope.Payments[i].id!=easybuy.PaymentMethods.WechatPay||easybuy.isWechat?$scope.Payments[i].checked&&(isChecked=!0):$scope.Payments.splice(i,1);isChecked||$.each($scope.Payments,function(i,item){return item.id==easybuy.PaymentMethods.AlipayWeb?(item.checked=!0,!1):void 0}),$scope.pay=function(orderNum,totalPrice,address,returnTime,id){httpRequest.APIPOST("/order/checkDate",dataStringify("platform=all&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){address||(address=1),returnTime||(returnTime=2);var arrButton=["取消","确定"];openDialog("确认从购物袋中删除所有选中的商品？","支付方式",arrButton,4,function(r,pWay){if(r)if(pWay==easybuy.PaymentMethods.WechatPay)window.location.href=serviceUrl+"/order/pay/orderid/"+orderNum+"/amount/"+totalPrice+"/address/"+address+"/time/"+returnTime;else if(easybuy.isWechat){var url=$location.absUrl().split("#")[0]+"#/dividedPay/"+orderNum+"/"+totalPrice;window.location.href=url}else window.location.href=paymentUrl+"callback=1&out_trade_no="+orderNum+"&total_fee="+totalPrice})}else alertWarning(result.msg)})},$scope.deleteOrder=function(id){var arrButton=["取消","确定"];openDialog("确认删除当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/delete",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("删除成功！"),httpRequest.APIPOST("/order/list",dataStringify("platform=all&token="+token+"&category=1&pageNo="+pageNo+"&pageSize="+pageSize),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?($scope.orders=result.result,hideLoading(),$scope.orders&&$scope.orders.length<1&&($scope.orders=null)):(hideLoading(),alert(result.msg))
})):(hideLoading(),alert(result.msg))}))})},$scope.cancelOrder=function(id,index){var arrButton=["取消","确定"];openDialog("确认取消当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/cancel",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("取消成功！"),$scope.orders[index].status=4):(hideLoading(),alert(result.msg))}))})},$scope.takeOverOrder=function(id,index){showLoading(),httpRequest.APIPOST("/order/confirm",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("收货成功！"),$scope.orders[index].status=3):(hideLoading(),alert(result.msg))})},$scope.back=function(){$location.path("/myProfile")}}),app.controller("orderDetailController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){function checkToken(){return!token||token&&token.length<12?!1:!0}$scope.orderId=$routeParams.id,$scope.token=$routeParams.token,$scope.totalNum=0,$scope.totalAmount=0;var token=$scope.token;$scope.getOrderStatus=function(status,category){return 1==status?"等待付款":2==status&&category&&3==category?"进行中":2==status&&3!=category?"等待确认收货":3==status&&category&&3==category?"交易成功":3==status&&3!=category?"交易成功":4==status?"订单已取消":5==status&&3!=category?"退款中":6==status&&3!=category?"退款成功":7==status?"已失效":void 0},$scope.deleteOrder=function(id){if(checkToken()){var arrButton=["取消","确定"];openDialog("确认删除当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/delete",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("删除成功！"),$location.path("/orderList/"+token)):(hideLoading(),alert(result.msg))}))})}else{var tokenInfo=getToken();if(tokenInfo&&tokenInfo.token){token=tokenInfo.token;var arrButton=["取消","确定"];openDialog("确认删除当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/delete",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("删除成功！"),$location.path("/orderList/"+token)):(hideLoading(),alert(result.msg))}))})}else $location.path(easybuy.isWechat?"/wechatOauth/orderDetail-"+$routeParams.id:"/myProfile/orderDetail-"+$routeParams.id)}},$scope.drawbackOrder=function(id){if(checkToken()){var arrButton=["取消","确定"];openDialog("确认退款？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/refund",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("退款成功！"),$scope.order.status=5):(hideLoading(),alert(result.msg))}))})}else{var tokenInfo=getToken();if(tokenInfo&&tokenInfo.token){token=tokenInfo.token;var arrButton=["取消","确定"];openDialog("确认退款？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/refund",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("退款成功！"),$scope.order.status=5):(hideLoading(),alert(result.msg))}))})}else $location.path(easybuy.isWechat?"/wechatOauth/orderDetail-"+$routeParams.id:"/myProfile/orderDetail-"+$routeParams.id)}},$scope.cancelOrder=function(id){if(checkToken()){var arrButton=["取消","确定"];openDialog("确认取消当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/cancel",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("取消成功！"),$scope.order.status=4):(hideLoading(),alert(result.msg))}))})}else{var tokenInfo=getToken();if(tokenInfo&&tokenInfo.token){token=tokenInfo.token;var arrButton=["取消","确定"];openDialog("确认取消当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/cancel",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("取消成功！"),$scope.order.status=4):(hideLoading(),alert(result.msg))}))})}else $location.path(easybuy.isWechat?"/wechatOauth/orderDetail-"+$routeParams.id:"/myProfile/orderDetail-"+$routeParams.id)}},$scope.takeOverOrder=function(id){if(checkToken())showLoading(),httpRequest.APIPOST("/order/confirm",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("收货成功！"),$scope.order.status=3):(hideLoading(),alert(result.msg))});else{var tokenInfo=getToken();tokenInfo&&tokenInfo.token?(token=tokenInfo.token,showLoading(),httpRequest.APIPOST("/order/confirm",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("收货成功！"),$scope.order.status=3):(hideLoading(),alert(result.msg))})):$location.path(easybuy.isWechat?"/wechatOauth/orderDetail-"+$routeParams.id:"/myProfile/orderDetail-"+$routeParams.id)}},!$scope.orderId&&getUserInfo()&&($scope.addressInfo=getUserInfo(),$scope.mobile=$scope.addressInfo.mobile),$scope.orderId?httpRequest.APIPOST("/order/detail",dataStringify("platform=all&category=1&orderId="+$scope.orderId),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){if($scope.order=result.result,$scope.order&&$scope.order.goodsList&&$scope.order.goodsList.length>0){for(var i=0;i<$scope.order.goodsList.length;i++)$scope.order.goodsList[i].quantity=parseInt($scope.order.goodsList[i].quantity),$scope.totalNum+=$scope.order.goodsList[i].quantity,$scope.totalAmount+=$scope.order.goodsList[i].quantity*$scope.order.goodsList[i].buyPrice;"''"==$scope.order.comments&&($scope.order.comments="")}}else alert(result.msg)}):$scope.order=!1,$scope.showLarge=function(imgUrl){showLargeImage(imgUrl)},$scope.go=function(){$location.path("/products")},$scope.Payments=easybuy.Payments;for(var isChecked=!1,i=$scope.Payments.length-1;i>=0;i--)$scope.Payments[i].id!=easybuy.PaymentMethods.WechatPay||easybuy.isWechat?$scope.Payments[i].checked&&(isChecked=!0):$scope.Payments.splice(i,1);isChecked||$.each($scope.Payments,function(i,item){return item.id==easybuy.PaymentMethods.AlipayWeb?(item.checked=!0,!1):void 0}),$scope.pay=function(orderNum,totalPrice,address,returnTime,id){httpRequest.APIPOST("/order/checkDate",dataStringify("platform=all&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){var arrButton=["取消","确定"];address||(address=1),returnTime||(returnTime=2),openDialog("确认从购物袋中删除所有选中的商品？","支付方式",arrButton,4,function(r,pWay){if(r)if(pWay==easybuy.PaymentMethods.WechatPay)window.location.href=serviceUrl+"/order/pay/orderid/"+orderNum+"/amount/"+totalPrice+"/address/"+address+"/time/"+returnTime;else if(easybuy.isWechat){var url=$location.absUrl().split("#")[0]+"#/dividedPay/"+orderNum+"/"+totalPrice;window.location.href=url}else window.location.href=paymentUrl+"callback=1&out_trade_no="+orderNum+"&total_fee="+totalPrice})}else alertWarning(result.msg)})},$scope.back=function(){var data=getToken();$location.path(data&&data.token?"/orderList/"+data.token:"/orderList")}}),app.controller("airportServiceController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){function appendComments(pageNum){$scope.isloading=!0,httpRequest.APIPOST("/airportSave/listComment",dataStringify("platform=all&objectId=1&pageNo="+pageNum+"&pageSize=10"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if($scope.isloading=!1,result&&result.code==statusCode.Success){$scope.commentInfo=result.result,$scope.page=result.page,$scope.commentInfo&&$(".rateTotal").raty({path:"image/raty",size:15,score:$scope.commentInfo.commentScore,readOnly:!0});var comments=$scope.commentInfo.comments;if(comments){var index=0;$scope.comments?(index=$scope.comments.length,$scope.comments=$scope.comments.concat(comments)):$scope.comments=comments,setTimeout(function(){$scope.$apply($scope.comments),$.each($(".product-item-comment:eq("+index+")").nextAll().andSelf(),function(i,item){$(item).find(".itemRate").raty({path:"image/raty",size:15,score:parseInt($(item).find(".itemRate").attr("score")),readOnly:!0}),$(item).find(".itemRate").css("width","100%")})},0)}}loadObj.clear(),$(".pull-loading").html("上拉加载")})}var isInApp=isApp($location);$scope.price="10.00",$scope.promotePrice="0",$scope.isloading=!0,httpRequest.APIPOST("/airportSave/info",dataStringify("platform=all"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){$scope.isloading=!1,result&&result.code==statusCode.Success&&($scope.price=result.result.price,$scope.promotePrice=result.result.promotePrice,$scope.airportSaveInfo=result.result,$("#description").html(result.result.description),$("#contact").html(result.result.contact),$("#serviceScope").html(result.result.serviceScope),$("#express").html(result.result.courier))}),$scope.isInApp=isInApp?!0:!1,$scope.needService=function(){return isInApp?void(window.location.href=easybuy.appActivity+"?action=2001&price="+$scope.price+"&promotePrice="+$scope.promotePrice):void $location.path("/airportServiceOrder").search({price:$scope.price,promotePrice:$scope.promotePrice})},$scope.back=function(){$location.path("/products")},$scope.isCollapse=!1,$scope.collapseComments=function(){$scope.isCollapse=$scope.isCollapse?!1:!0},$scope.pageNum=1,appendComments($scope.pageNum);var clientH=$(window).height(),maxHeight=0;$(".tab-content .tab-pane").each(function(i,e){var t=$(e).height();t>maxHeight&&(maxHeight=t)}),$(".tab-content .tab-pane").css("overflow-y","auto"),$(".tab-content .tab-pane").css("padding-bottom","50px"),$(".tab-content .tab-pane").height(clientH-145),$scope.changeTab=function(){},$(".scrollable-content").scroll(50,function(){})}),app.controller("airportServiceOrderController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){function oauthCallback(token){showLoading(),httpRequest.APIPOST("/address/default",dataStringify("platform=all&token="+token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){$scope.addressInfo=result.result;var addressInfo={},addressInfo2=getAddressTemp();null==addressInfo2&&(addressInfo2=getUserInfoService()),addressInfo=$scope.addressInfo,addressInfo2&&(addressInfo2.shopName&&(addressInfo.shopName=addressInfo2.shopName),addressInfo2.shopPhone&&(addressInfo.shopPhone=addressInfo2.shopPhone)),$scope.days=0;var startdate=new Date;startdate.setHours(startdate.getHours()+48);var m=startdate.getMinutes()%5;0!=m&&startdate.setMinutes(startdate.getMinutes()+(5-m)),startdate.setSeconds(0),startdate.setMilliseconds(0),$scope.minDateTime=startdate;var enddate=new Date;enddate.setMonth(enddate.getMonth()+6),enddate.setHours(23),enddate.setMinutes(59),enddate.setSeconds(59),enddate.setMilliseconds(999),$scope.maxDateTime=enddate,opt.datetime={dateOrder:"yymmdd",dateFormat:"yyyy-mm-dd",preset:"datetime",minDate:startdate,maxDate:enddate,stepMinute:5,onSelect:function(){$scope.saveTemp(),$scope.time=$("#appDateTime").val(),event.stopPropagation()}};{var optDateTime=$.extend(opt.datetime,opt.Default);$.extend(opt.time,opt.Default)}$("#appDateTime").mobiscroll(optDateTime).date(optDateTime),addressInfo&&(fillAddressInputs(addressInfo),setAddressTemp(generateAddressTemp($scope,"#appDateTime","#agentRegion")))}else alertWarning(result.msg)})}function fillAddressInputs(addressInfo){if(addressInfo){if(addressInfo.nick_name&&($scope.name=addressInfo.nick_name),addressInfo.take_off_time){$scope.time=addressInfo.take_off_time,$("#appDateTime").val(addressInfo.take_off_time);var enddate=new Date(addressInfo.take_off_time.replace(/-/g,"/"));$scope.days=countDays(enddate),$scope.days=$scope.days<0?0:$scope.days,$scope.$apply($scope.days),$scope.returnDate=addressInfo.take_off_time.split(" ")[0],$scope.returnTime=addressInfo.take_off_time.split(" ")[1]}if(addressInfo.returnTime){$scope.time=addressInfo.returnDate+" "+addressInfo.returnTime,$("#appDateTime").val($scope.time);var enddate=new Date($scope.time.replace(/-/g,"/"));$scope.days=countDays(enddate),$scope.days=$scope.days<0?0:$scope.days,$scope.$apply($scope.days),$scope.returnDate=addressInfo.returnDate,$scope.returnTime=addressInfo.returnTime}addressInfo.contact&&($scope.name=addressInfo.contact),addressInfo.mobile&&($scope.mobile=addressInfo.mobile),addressInfo.agentComment&&($scope.agentComment=addressInfo.agentComment),addressInfo.returnAirportId&&($scope.returnAirportId=addressInfo.returnAirportId,$scope.returnAirport=addressInfo.returnAirport),addressInfo.returnFlightno&&($scope.returnFlightno=addressInfo.returnFlightno),addressInfo.shopName&&($scope.shopName=addressInfo.shopName),addressInfo.shopPhone&&($scope.shopPhone=addressInfo.shopPhone)}}var user=$location.$$search,countDays=function(enddate){var now=new Date;return now.setHours(0),now.setMinutes(0),now.setSeconds(0),now.setMilliseconds(0),enddate.setHours(0),enddate.setMinutes(0),enddate.setSeconds(0),enddate.setMilliseconds(0),enddate.diff(now)},param=$location.search();if(param&&(!param||param.price&&param.promotePrice)?($scope.promotePrice=param.promotePrice,$scope.price=param.price-param.promotePrice):httpRequest.APIPOST("/airportSave/info",dataStringify("platform=all"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){$scope.isloading=!1,result&&result.code==statusCode.Success&&($scope.price=parseFloat(result.result.price)-parseFloat(result.result.promotePrice),$scope.promotePrice=parseFloat(result.result.promotePrice))}),user.openId&&4!=user.source){var source=user.source,data="platform=all&openid="+user.openId+"&nickname="+user.nickname+"&gender=0&avatar="+user.headimgurl+"&source="+source+"&channel=H5&appVersion="+easybuy.version;httpRequest.APIPOST("/user/thirdLogin",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.currentUser=result.result,$scope.currentUser.openId=user.openId,$scope.currentUser.source=user.source,$scope.currentUser.nickname=user.nickname,$scope.currentUser.headimgurl=user.headimgurl,setToken($scope.currentUser),null!=$scope.currentUser.mobile&&$scope.currentUser.mobile||(void 0==$scope.currentUser.bind||$scope.currentUser.bind&&1==$scope.currentUser.bind)&&$location.path("/myPhone/0/"+$scope.currentUser.token).search({user:user,state:"airportServiceOrder"}),oauthCallback($scope.currentUser.token)):alert(result.msg)})}else $scope.currentUser=getToken(),$scope.currentUser&&$scope.currentUser.token?(null!=$scope.currentUser.mobile&&$scope.currentUser.mobile||(void 0==$scope.currentUser.bind||$scope.currentUser.bind&&1==$scope.currentUser.bind)&&$location.path("/myPhone/0/"+$scope.currentUser.token).search({user:$scope.currentUser,state:"airportServiceOrder"}),oauthCallback($scope.currentUser.token)):$location.path(easybuy.isWechat?"/wechatOauth/airportServiceOrder":"/myProfile/airportServiceOrder");$scope.date=function(){$("#appDateTime").mobiscroll("show")},$scope.validNum=function(){$scope.mobile=validInteger($scope.mobile)},$scope.search=function(){var flightNo=$scope.returnFlightno;if(void 0==flightNo&&(flightNo=""),flightNo.length>=2&&$scope.time){var data="platform=all&backFlightno="+$scope.returnFlightno+"&backDate="+$scope.time;httpRequest.APIPOST("/flight/back",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.returnAirportId=result.result.returnAirportId,$scope.returnAirport=result.result.returnAirport,$scope.returnTime=result.result.returnTime,$scope.time||($scope.time=""),$("#appDateTime").val($scope.time.split(" ")[0]+" "+result.result.returnTime),$scope.time=$scope.time.split(" ")[0]+" "+result.result.returnTime,$scope.saveTemp()):($scope.returnAirportId=-1,$scope.returnAirport="",alertWarning(result.msg))})}},$scope.saveTemp=function(){setAddressTemp(generateAddressTemp($scope,"#appDateTime","#agentRegion"));var enddate=new Date($("#appDateTime").val().replace(/-/g,"/"));$scope.days=countDays(enddate),$scope.days=$scope.days?$scope.days:0,$scope.$apply($scope.days)},$scope.getFlightTime=function(callback){var flightNo=$scope.returnFlightno;if(void 0==flightNo&&(flightNo=""),flightNo.length>=2&&$scope.time){var data="platform=all&backFlightno="+$scope.returnFlightno+"&backDate="+$scope.time;httpRequest.APIPOST("/flight/back",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.returnAirportId=result.result.returnAirportId,$scope.returnAirport=result.result.returnAirport,$scope.returnTime=result.result.returnTime,$scope.time||($scope.time=""),$("#appDateTime").val($scope.time.split(" ")[0]+" "+result.result.returnTime),$scope.time=$scope.time.split(" ")[0]+" "+result.result.returnTime,$scope.saveTemp(),callback()):($scope.returnAirportId=-1,$scope.returnAirport="",alertWarning(result.msg))})}},$scope.confirmOrder=function(){if(!$scope.name||""==$scope.name.toString().trim())return void alertWarning("请填写联系人姓名");if($scope.name.toString().length<2||$scope.name.toString().length>20)return void alertWarning("请输入2~20位的联系人姓名");if(!$scope.mobile||""==$scope.mobile)return void alertWarning("请填写手机号码");if($scope.mobile.toString().length<9||$scope.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");var flightTime=$("#appDateTime").val();if(!flightTime||""==flightTime)return void alertWarning("请选择回程起飞时间");if(new Date(flightTime.replace(/-/g,"/"))<$scope.minDateTime)return void alertWarning("回程起飞时间请选择48小时后");if(!$scope.returnFlightno||""==$scope.returnFlightno)return void alertWarning("请输入回程航班号");if(!$scope.shopName||""==$scope.shopName)return void alertWarning("请输入商家名称");if(!$scope.shopPhone||""==$scope.shopPhone)return void alertWarning("请输入商家联系电话");if(void 0==$scope.agentComment)$scope.agentComment="";else if($scope.agentComment.length>100)return void alertWarning("请输入100位以内的备注");$scope.getFlightTime(function(){if(!$scope.returnAirportId)return void alertWarning("请输入正确的航班号和选择合理的回程日期");var name="",flightId=1,mobile="",returnFlightno="";name=$scope.name,mobile=$scope.mobile,flightId=$scope.returnAirportId,returnFlightno=$scope.returnFlightno,$scope.isNextStep=!0,setUserInfoService({returnAirport:$scope.returnAirport,returnAirportId:flightId,returnFlightno:returnFlightno,shopName:$scope.shopName,shopPhone:$scope.shopPhone,nick_name:name,mobile:mobile,flight_id:flightId,terminal:$scope.returnAirport,take_off_time:$scope.time,agentComment:$scope.agentComment}),clearAddressTemp(),$scope.returnDate=flightTime.split(" ")[0],$scope.returnTime=flightTime.split(" ").length>1?flightTime.split(" ")[1]:"";$scope.agentComment?"&comments="+$scope.agentComment:""})},$scope.Payments=easybuy.Payments;for(var isChecked=!1,i=$scope.Payments.length-1;i>=0;i--)$scope.Payments[i].id!=easybuy.PaymentMethods.WechatPay||easybuy.isWechat?$scope.Payments[i].checked&&(isChecked=!0):$scope.Payments.splice(i,1);isChecked||$.each($scope.Payments,function(i,item){return item.id==easybuy.PaymentMethods.AlipayWeb?(item.checked=!0,!1):void 0}),$scope.checked=function(payment){$.each($scope.Payments,function(i,item){item.checked=!1}),payment.checked=!0},$scope.needService=function(){if(!$scope.name||""==$scope.name.toString().trim())return void alertWarning("请填写联系人姓名");if($scope.name.toString().length<2||$scope.name.toString().length>20)return void alertWarning("请输入2~20位的联系人姓名");if(!$scope.mobile||""==$scope.mobile)return void alertWarning("请填写手机号码");if($scope.mobile.toString().length<9||$scope.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");var flightTime=$("#appDateTime").val();if(!flightTime||""==flightTime)return void alertWarning("请选择回程起飞时间");if(new Date(flightTime.replace(/-/g,"/"))<$scope.minDateTime)return void alertWarning("回程起飞时间请选择48小时后");if(!$scope.returnFlightno||""==$scope.returnFlightno)return void alertWarning("请输入回程航班号");if(!$scope.shopName||""==$scope.shopName)return void alertWarning("请输入商家名称");if(!$scope.shopPhone||""==$scope.shopPhone)return void alertWarning("请输入商家联系电话");if(void 0==$scope.agentComment)$scope.agentComment="";else if($scope.agentComment.length>100)return void alertWarning("请输入100位以内的备注");if(!$scope.returnAirportId)return void alertWarning("请输入正确的航班号和选择合理的回程日期");var name="",flightId=1,mobile="",returnFlightno="";name=$scope.name,mobile=$scope.mobile,flightId=$scope.returnAirportId,returnFlightno=$scope.returnFlightno,$scope.isNextStep=!0,setUserInfoService({returnAirport:$scope.returnAirport,returnAirportId:flightId,returnFlightno:returnFlightno,shopName:$scope.shopName,shopPhone:$scope.shopPhone,nick_name:name,mobile:mobile,flight_id:flightId,terminal:$scope.returnAirport,take_off_time:$scope.time,agentComment:$scope.agentComment}),clearAddressTemp(),$scope.returnDate=flightTime.split(" ")[0],$scope.returnTime=flightTime.split(" ").length>1?flightTime.split(" ")[1]:"";var payWay=null;if($.each($scope.Payments,function(i,item){return 1==item.checked?(payWay=item.id,!1):void 0}),null==payWay)return void alertWarning("请选择支付方式");if(payWay==easybuy.PaymentMethods.AlipayWallet)return void alertWarning("无法使用支付宝钱包");var comments=$scope.agentComment?"&comments="+$scope.agentComment:"",data="platform=all&token="+$scope.currentUser.token+"&days="+$scope.days+"&contact="+name+"&mobile="+mobile+"&returnTime="+flightTime+"&returnAirportId="+flightId+"&returnFlightno="+returnFlightno+"&shopName="+$scope.shopName+"&shopPhone="+$scope.shopPhone+"&source=2"+comments;httpRequest.APIPOST("/order/addAirportSaveOrder",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(showLoading(),payWay==easybuy.PaymentMethods.WechatPay?window.location.href=serviceUrl+"/order/pay/orderid/"+result.result.orderNum+"/amount/"+result.result.totalPrice+"/address/address/time/returnTime":easybuy.isWechat?window.location.hash="#/dividedPay/"+result.result.orderNum+"/"+result.result.totalPrice:window.location.href=paymentUrl+"callback=1&out_trade_no="+result.result.orderNum+"&total_fee="+result.result.totalPrice):alert(result.msg)})},$scope.back=function(){$scope.isNextStep?$scope.isNextStep=!1:$location.path("/airportService")}}),app.controller("paymentAppController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.isInCoupons=!1,$scope.id=$routeParams.id,$scope.area=parseInt($location.$$search.area)||1,$scope.user=$.parseJSON($location.$$search.user);var from=parseInt($routeParams.from)||0;$scope.products=$.parseJSON($location.$$search.goods),$scope.totalAmount=0,$scope.totalJs=0,$scope.payAmount=0;var couponsIds=[],couponsNums=[];clearAddressTemp(),$scope.addressURL=2==$scope.area?"#/address/"+$scope.id+"/2?token="+$scope.user.token:"#/address/"+$scope.id+"?token="+$scope.user.token;var isPaying=!1,goods=[];if(1==from){if($scope.products&&$scope.products.length>0)for(var i=0;i<$scope.products.length;i++)for(var j=0;j<$scope.products[i].goodsList.length;j++)if($scope.products[i].goodsList[j].checked){var good=$scope.products[i].goodsList[j];goods.push(good)}}else if(2==from){if($scope.products&&$scope.products.length>0)for(var i=0;i<$scope.products.length;i++){var good=$scope.products[i];good.price=good.promotePrice,good.id=good.goodsId,good.price=good.buyPrice,goods.push(good)}}else if($scope.products&&$scope.products.length>0)for(var i=0;i<$scope.products.length;i++){var good=$scope.products[i];good.quantity=good.num,good.img=good.smallImg,good.price=good.promotePrice,goods.push(good)}for(var goodsIdStr="",quantityStr="",i=0;i<goods.length;i++)i<goods.length-1?(goodsIdStr=goodsIdStr+goods[i].id+",",quantityStr=quantityStr+goods[i].quantity+","):(goodsIdStr+=goods[i].id,quantityStr=quantityStr+goods[i].quantity+",");if($scope.products=goods,$scope.user&&$scope.user.token&&httpRequest.APIPOST("/address/default",dataStringify("platform=all&token="+$scope.user.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?$scope.addressInfo=result.result:alertWarning(result.msg)}),getUserInfo()){var userInfo=getUserInfo();$scope.comments=userInfo.comments}var provinceId="";2==$scope.area&&$scope.addressInfo&&$scope.addressInfo.agentRegionIds&&(provinceId="&provinceId="+$scope.addressInfo.agentRegionIds.split(",")[0]);var token="";if(easybuy.isWechat){var tokenInfo=getToken();token="&token="+tokenInfo.token}httpRequest.APIPOST("/order/price",dataStringify("platform=all&category=1&goodsId="+goodsIdStr+"&quantity="+quantityStr+provinceId+token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.totalAmount=result.result,$scope.totalJs=$scope.totalAmount.js,$scope.payAmount=$scope.totalAmount.total):alert(result.msg)}),(getMobileType()==MobileTypes.iPhone||getMobileType()==MobileTypes.iPad)&&(window.onresize=function(){refixNavBottom()},window.onresize()),$scope.Payments=easybuy.Payments;for(var isChecked=!1,i=$scope.Payments.length-1;i>=0;i--)$scope.Payments[i].id!=easybuy.PaymentMethods.WechatPay||easybuy.isWechat?$scope.Payments[i].checked&&(isChecked=!0):$scope.Payments.splice(i,1);isChecked||$.each($scope.Payments,function(i,item){return item.id==easybuy.PaymentMethods.AlipayWeb?(item.checked=!0,!1):void 0}),$scope.checked=function(payment){$.each($scope.Payments,function(i,item){item.checked=!1}),payment.checked=!0},$scope.pay=function(){if(!isPaying){if(!$scope.addressInfo)return void alertWarning("请填写联系人信息");if($scope.comments&&$scope.comments.length>100)return void alertWarning("请输入100位以内的备注");if(1==$scope.area&&new Date($scope.addressInfo.returnDate+" "+$scope.addressInfo.returnTime)<new Date)return void alertWarning("起飞时间已过，请重新填写");var payWay=null;if($.each($scope.Payments,function(i,item){return 1==item.checked?(payWay=item.id,!1):void 0}),null==payWay)return void alertWarning("请选择支付方式");if(payWay==easybuy.PaymentMethods.AlipayWallet)return void alertWarning("无法使用支付宝钱包");var goodsId="",quantity="";$.each($scope.products,function(i,product){goodsId=i==$scope.products.length-1?goodsId+product.id:goodsId+product.id+",",quantity=i==$scope.products.length-1?quantity+product.quantity:quantity+product.quantity+","});var contact=$scope.addressInfo.contact,mobile=$scope.addressInfo.mobile,returnTime="&returnTime="+$scope.addressInfo.returnDate+" "+$scope.addressInfo.returnTime;void 0==$scope.addressInfo.returnTime&&(returnTime="");var returnAirportId=parseInt($scope.addressInfo.returnAirportId),returnFlightno=$scope.addressInfo.returnFlightno,address="";address=1==$scope.area?$scope.addressInfo.returnAirport:$scope.addressInfo.detailAddress;var comment=$scope.comments?"&comments="+$scope.comments:"&comments=''";if((!$scope.user||$scope.user&&!$scope.user.token)&&($scope.user=getToken()),$scope.user&&$scope.user.token){var token=$scope.user.token,couponsIdsStr="",couponsNumsStr="";couponsIds.length>0&&couponsNums.length>0&&(couponsIdsStr="&couponsId="+couponsIds.join(","),couponsNumsStr="&couponsNum="+couponsNums.join(","));var url="platform=all&token="+token+"&contact="+contact+"&mobile="+mobile+returnTime+"&returnAirportId="+returnAirportId+"&returnFlightno="+returnFlightno+comment+"&goodsId="+goodsId+"&quantity="+quantity+couponsIdsStr+couponsNumsStr;isPaying=!0,$("#btnPay").text("下单中..."),httpRequest.APIPOST("/order/addGoodsOrder",dataStringify(url),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){if(1==from){for(var cartProducts=getCart(),tempCart=[],i=0;i<cartProducts.length;i++){for(var isHav=!1,j=0;j<$scope.products.length;j++)cartProducts[i].id==$scope.products[j].id&&(isHav=!0);isHav||tempCart.push(cartProducts[i])}setCart(tempCart)}setUserInfo(null),$("#btnPay").text("正跳转..."),payWay==easybuy.PaymentMethods.WechatPay?window.location.href=serviceUrl+"/order/pay/orderid/"+result.result.orderNum+"/amount/"+result.result.totalPrice+"/address/"+address+"/time/"+returnTime:easybuy.isWechat?window.location.hash="#/dividedPay/"+result.result.orderNum+"/"+result.result.totalPrice:window.location.href=paymentUrl+"callback=1&out_trade_no="+result.result.orderNum+"&total_fee="+result.result.totalPrice}else alertWarning(result.msg)})}else $location.path("/myProfile")}},$scope.saveUserInfo=function(){var info={};info=$scope.addressInfo,info.comments=$scope.comments,setUserInfo(info)},$scope.choseCoupon=function(){var tokenInfo=getToken(),tk="";if($scope.user&&$scope.user.token?tk=$scope.user.token:tokenInfo&&tokenInfo.token&&(tk=tokenInfo.token),!$scope.coupons){var data="platform=all&token="+tk+"&goodsId="+goodsIdStr+"&quantity="+quantityStr;showLoading(),httpRequest.APIPOST("/order/coupons",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(hideLoading(),$scope.coupons=result.result):(hideLoading(),alertWarning(result.msg))})}$scope.isInCoupons=!0},$scope.back=function(){if($scope.isInCoupons){$scope.isInCoupons=!1;for(var i=0;i<$scope.coupons.canUseList.length;i++){var isShow=$scope.coupons.canUseList[i].checked;isShow?$("#i_coupon_"+i).css("display","block"):$("#i_coupon_"+i).css("display","none")}}else history.back()},$scope.couponsNumOrigin=0,$scope.couponsJsOrigin=0,$scope.confirmCoupon=function(){var js=0,num=0;couponsIds=[],couponsNums=[];for(var i=0;i<$scope.coupons.canUseList.length;i++){var isShow="block"==$("#i_coupon_"+i).css("display");isShow?($scope.coupons.canUseList[i].checked=!0,js+=parseFloat($scope.coupons.canUseList[i].amount),num++,couponsIds.push($scope.coupons.canUseList[i].couponId),couponsNums.push(1)):$scope.coupons.canUseList[i].checked=!1}$scope.couponsNumOrigin=num,$scope.couponsJsOrigin=js,$scope.totalJs=$scope.totalAmount.js+js,$scope.payAmount=$scope.totalAmount.total-js,$scope.isInCoupons=!1},$scope.tapCoupon=function(amount,index){var isShow="block"==$("#i_coupon_"+index).css("display");isShow?$("#i_coupon_"+index).css("display","none"):$("#i_coupon_"+index).css("display","block")}}),app.controller("dividedPayController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.order={},$scope.order.orderNum=$routeParams.orderNum,$scope.order.fee=$routeParams.fee,$scope.pay=function(){window.location.href=paymentUrl+"callback=2&out_trade_no="+$scope.order.orderNum+"&total_fee="+$scope.order.fee},$scope.isWechat=easybuy.isWechat}),app.controller("successController",function($rootScope,$scope,httpRequest,analytics,$location,$window,$routeParams){var isApp="app"==$location.search().payType?!0:!1;$scope.isApp=isApp,$routeParams.ordersn&&(removeOrder(),$scope.time=$routeParams.time,$scope.address=$routeParams.address),$scope.goHome=function(){return isApp?void(window.location.href=easybuy.appActivity+"?action=17"):void $location.path("/products")},$scope.view=function(){return isApp?void(window.location.href=easybuy.appActivity+"?action=16&orderId="+$routeParams.ordersn):void $location.path("/orderDetail/"+$routeParams.ordersn+"/"+$routeParams.token)},$scope.back=function(){$location.path("/products")}}),app.controller("errorController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){var isApp="app"==$location.search().payType?!0:!1;$scope.isApp=isApp,$scope.goHome=function(){return isApp?void(window.location.href=easybuy.appActivity+"?action=17"):void $location.path("/products")
},$scope.again=function(){if(isApp)return void(window.location.href=easybuy.appActivity+"?action=18");if($routeParams.orderId){var orderId=$routeParams.orderId,mobile=$routeParams.mobile;httpRequest.APIPOST("/user/h5Login",dataStringify("platform=all&account="+mobile+"&password="+mobile),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){var token=result.result;setToken({token:token,mobile:mobile}),httpRequest.APIPOST("/order/detail",dataStringify("platform=all&token="+token+"&category=1&orderId="+orderId),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){var order=result.result;$location.path("/pay/"+orderId+"/2").search({area:order.area,goods:JSON.stringify(order.goodsList)})}else alert(result.msg)})}})}else $location.path("/products")},$scope.back=function(){$location.path("/products")}}),app.controller("myPhoneController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.mobile=$routeParams.mobile||"",$scope.token=$routeParams.token||getToken().token,$scope.isSetMobile=$routeParams.mobile?!0:!1,"0"==$routeParams.mobile&&($scope.isSetMobile=!1,$scope.mobile=""),easybuy.isWechat&&!$routeParams.token&&getToken()&&getToken().token&&httpRequest.APIPOST("/mine/index",dataStringify("platform=all&token="+getToken().token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var userInfo=result.result;$scope.mobile=userInfo.mobile,$scope.mobile&&($scope.isSetMobile=!0)}else alertWarning(result.msg)}),$scope.focus=function(){$("#myPhoneNumber").focus()},$scope.back=function(){$location.path("/myProfile")},$scope.setPhone=function(){if(!$scope.mobile||$scope.mobile.toString().length<9||$scope.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");if(!$scope.code||$scope.code.toString().length<4||$scope.code.toString().length>8)return void alertWarning("请输入验证码");var data="platform=all&token="+$scope.token+"&mobile="+$scope.mobile+"&code="+$scope.code;$scope.wait=0,showLoading(),httpRequest.APIPOST("/user/bindMobile",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){alertWarning("手机号设置成功");var temp=getToken();if(temp&&(temp.mobile=$scope.mobile,setToken(temp)),$location.$$search&&$location.$$search.user&&$location.$$search.user.openId){var arr=$location.$$search.state.split("-");if("orderDetail"==arr[0])return void $location.path("/orderDetail/"+arr[1]+"/"+$scope.token).search(user);if(arr.length<2)return void $location.path("/"+$location.$$search.state).search($location.$$search.user);if(2==arr.length)return void $location.path("/"+arr[0]+"/"+arr[1]).search($location.$$search.user);if(3==arr.length)return void $location.path("/"+arr[0]+"/"+arr[1]+"/"+arr[2]).search($location.$$search.user)}else $location.path("/myProfile")}else alertWarning(result.msg)})},$scope.wait=60;var time=function(){0==$scope.wait?($scope.wait=60,$("#codeClock").css("display","none")):($scope.wait--,$scope.$apply($scope.wait),setTimeout(function(){time()},1e3))};$scope.getCheckCode=function(){if($scope.mobile.toString().length<9||$scope.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");$("#codeClock").css("display","inline-block"),time();var data="platform=all&type=3&mobile="+$scope.mobile;httpRequest.APIPOST("/sms/getVerifyCode",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success||alertWarning(result.msg)})}}),app.controller("myCouponController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.token=$routeParams.token?$routeParams.token:getToken()?getToken().token:"";var from=$location.search()&&$location.search().from?$location.search().from:"";if(easybuy.isWechat&&!$routeParams.token&&"activity"==from){var t=getToken();if($scope.token=t.token,!t.mobile||t.mobile&&t.mobile.length<6)return void $location.path("/wechatOauth/myCoupon").search({from:from})}if($scope.token){var data="platform=all&token="+$scope.token;showLoading(),httpRequest.APIPOST("/coupons/mine",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(hideLoading(),$scope.coupons=result.result):(hideLoading(),alert(result.msg))})}else $location.path("/myProfile");$scope.back=function(){$location.search()&&$location.search().from?history.back():$location.path("/myProfile")}}),app.controller("oauth2Controller",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){var nickname=$location.$$search.nickname,headimgurl=$location.$$search.headimgurl,openId=$routeParams.openId,state=$routeParams.state,source=$location.$$search.source?$location.$$search.source:1;if($rootScope.isOauth2=!0,4==source){var usertokenInfo=getToken(),arr=state.split("-");if("orderDetail"==arr[0])return void $location.path("/orderDetail/"+arr[1]+"/"+usertokenInfo.token).search(usertokenInfo);if(arr.length<2)return void $location.path("/"+state).search(usertokenInfo);if(2==arr.length)return void $location.path("/"+arr[0]+"/"+arr[1]).search(usertokenInfo);if(3==arr.length)return void $location.path("/"+arr[0]+"/"+arr[1]+"/"+arr[2]).search(usertokenInfo)}var user={openId:openId,nickname:nickname,headimgurl:headimgurl,source:source},source=user.source,data="platform=all&openid="+user.openId+"&nickname="+user.nickname+"&gender=0&avatar="+user.headimgurl+"&source="+source+"&channel=H5&appVersion="+easybuy.version;httpRequest.APIPOST("/user/thirdLogin",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success)if($scope.currentUser=result.result,$scope.currentUser.openId=user.openId,$scope.currentUser.source=user.source,$scope.currentUser.nickname=user.nickname,$scope.currentUser.headimgurl=user.headimgurl,(null==$scope.currentUser.mobile||!$scope.currentUser.mobile||$scope.currentUser.mobile&&$scope.currentUser.mobile.length<6)&&1!=isNotBindPhone[state]&&$scope.currentUser.source&&4!=$scope.currentUser.source)(0!=$scope.currentUser.bind||"0"!=$scope.currentUser.bind)&&$location.path("/myPhone/0/"+$scope.currentUser.token).search({user:user,state:state});else{setToken($scope.currentUser);var arr=state.split("-");if("orderDetail"==arr[0])return void $location.path("/orderDetail/"+arr[1]+"/"+$scope.currentUser.token).search(user);if(arr.length<2)return void $location.path("/"+state).search(user);if(2==arr.length)return void("activity"==arr[0]&&"activityDetail"==arr[1]?$location.path("/"+arr[0]+"/"+arr[1]):$location.path("/"+arr[0]+"/"+arr[1]).search(user));if(3==arr.length)return void $location.path("/"+arr[0]+"/"+arr[1]+"/"+arr[2]).search(user)}else alert(result.msg)})}),app.controller("wechatOauthController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){var state=$routeParams.state,from=$location.search()&&$location.search().from?$location.search().from:"";baseOauth[state]===!0&&"activity"!==from?$rootScope.oauth2(state,null):$rootScope.oauth2(state,"userinfo")}),app.controller("myController",function($rootScope,$scope,httpRequest,$http,dataStringify,analytics,$location,$window,$routeParams){function callback(u){var user=u?u:$location.$$search;if($scope.user=user,user&&user.openId){var source=user.source,data="platform=all&openid="+user.openId+"&nickname="+user.nickname+"&gender=0&avatar="+user.headimgurl+"&source="+source+"&channel=H5&appVersion="+easybuy.version;httpRequest.APIPOST("/user/thirdLogin",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.isLogin=!0,$scope.user=result.result,$scope.user.openId=user.openId,$scope.user.source=user.source,$scope.user.nickname=user.nickname,$scope.user.headimgurl=user.headimgurl,$scope.user.bind=1,null==$scope.user.mobile&&($scope.user.mobile="0"),$scope.user.mobile&&"0"!=$scope.user.mobile||$location.path("/myPhone/0/"+$scope.user.token).search({user:$scope.user,state:"myProfile"}),setToken($scope.user),$scope.isNeedBind=!0,$scope.$apply($scope.isNeedBind),$scope.$apply($scope.user)):alert(result.msg)})}else $scope.user=getToken(),$scope.user?($scope.isLogin=!0,(!$scope.user.mobile||$scope.user.mobile&&$scope.user.mobile.length<6)&&($scope.user.mobile=0)):($scope.isLogin=!1,$scope.user={}),$scope.$apply($scope.user),$scope.$apply($scope.isLogin)}$rootScope.$on("CtrlUserModule",function(event,isLogin){$scope.isLogin=isLogin});var from=$routeParams.from||"";$scope.isNeedBind=!0,$scope.from=from;var loginFrom=1;$scope.isLogin=!0,$scope.isShowLogoutBtn=!easybuy.isWechat,easybuy.isWechat||(getToken()?($scope.user=getToken(),$scope.isLogin=!0,$scope.isNeedBind=0==$scope.user.bind||"0"==$scope.user.bind||$scope.user.source&&4==$scope.user?!1:!0,loginFrom=$scope.user.source):$scope.isLogin=!1),$scope.login=function(){var u=$scope.username,p=$scope.password;if(!u||u&&u.length<1||!p||p&&p.length<1)return void alertWarning("请输入手机号/密码");if(11!=u.length||p.length<4||p.length>20)return void alertWarning("请输入正确的手机号或密码");var data="platform=all&account="+u+"&password="+p+"&category=2";httpRequest.APIPOST("/user/login",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var token=result.result.token,data2="platform=all&token="+token;httpRequest.APIPOST("/mine/index",dataStringify(data2),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var userInfo=result.result;if($scope.isLogin=!0,$scope.user={},$scope.user.token=token,$scope.user.openId="0",$scope.user.source=4,$scope.user.nickname=userInfo.nickname,$scope.user.headimgurl=userInfo.avatar,$scope.user.mobile=userInfo.mobible,$scope.user.bind=0,$scope.isNeedBind=!1,setToken($scope.user),"/myProfile"!=$location.path())return void($rootScope.isRootLogin=!0);from&&($location.path("/oauth2/"+$scope.user.openId+"/"+from).search({openId:$scope.user.openId,nickname:userInfo.nickname,headimgurl:userInfo.avatar,source:4,bind:$scope.user.bind}),$scope.$apply($location))}else alertWarning(result.msg)})}else alertWarning(result.msg)}),loginFrom=4},$scope.register=function(){$location.path("/register")},$scope.logout=function(){var arrButton=["取消","确定"];openDialog("您是否确认退出？",null,arrButton,null,function(r){if(r){if(4==loginFrom){var data="platform=all&token="+$scope.user.token;httpRequest.APIPOST("/user/logout",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.user={},removeToken(),$scope.isLogin=!1,$scope.$apply($scope.isLogin),$scope.$apply($scope.user),location.href=location.href.split("?")[0]):alertWarning(result.msg)})}$scope.user={},removeToken(),$scope.isLogin=!1,$scope.$apply($scope.isLogin),$scope.$apply($scope.user)}})},$scope.back=function(){$location.path("/products")},easybuy.isWechat&&callback(),$scope.validNum=function(){$scope.username=validInteger($scope.username)}}),app.controller("registerController",function($rootScope,$scope,httpRequest,$http,dataStringify,analytics,$location){$scope.register=function(){var u=$scope.username,c=$scope.code,p=$scope.password,ic=$scope.inviteCode;if(!u||u&&u.length<1)return void alertWarning("请输入手机号");if(11!=u.length)return void alertWarning("请输入11位的手机号码");if(!c||c.toString().length<4||c.toString().length>8)return void alertWarning("请输入验证码");if(!p||p.length<4||p.length>20)return void alertWarning("请输入4~20位的密码");if(!ic||ic.length<4||ic.length>20)return void alertWarning("请输入4~20位的密码");$scope.wait=0;var data="platform=all&mobile="+u+"&password="+p+"&code="+c+"&inviteCode="+ic;httpRequest.APIPOST("/user/register",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var token=result.result.token,data2="platform=all&token="+token;httpRequest.APIPOST("/mine/index",dataStringify(data2),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var userInfo=result.result;$scope.user={},$scope.user.token=token,$scope.user.openId="0",$scope.user.source=4,$scope.user.nickname=userInfo.nickname,$scope.user.headimgurl=userInfo.avatar,$scope.user.mobile=userInfo.mobible,$scope.user.bind=userInfo.bind||0,setToken($scope.user),$location.path("/myProfile")}else alertWarning(result.msg)})}else alertWarning(result.msg)})},$scope.back=function(){$location.path("/myProfile")},$scope.validNum=function(){$scope.username=validInteger($scope.username)},$scope.wait=60;var time=function(){0==$scope.wait?($scope.wait=60,$("#codeClock").css("display","none")):($scope.wait--,$scope.$apply($scope.wait),setTimeout(function(){time()},1e3))};$scope.getCheckCode=function(){if(!$scope.username||$scope.username.toString().length<9||$scope.username.toString().length>13)return void alertWarning("请输入9~13位的手机号码");$("#codeClock").css("display","inline-block"),time();var data="platform=all&type=1&mobile="+$scope.username;httpRequest.APIPOST("/sms/getVerifyCode",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success||alertWarning(result.msg)})}});