app.controller("navbarController",function($rootScope,$scope){$scope.back=function(){history.back()}}),app.controller("productListController",function($rootScope,$templateCache,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){var code=$routeParams.code||0;$scope.isSearchPage=!1,$scope.showSearch=function(){$scope.isSearchPage=!0,$("#searchPage").addClass("current")},$scope.$on("CtrlSearchPanel",function(event,isSearchPage){isSearchPage||$("#searchPage").removeClass("current"),$scope.isSearchPage=isSearchPage}),$rootScope.categoryId=code,$scope.code=code,$scope.user=getToken();var loadObj=new loadControl("#myLoadCanvas",function(){$(".pull-loading").html("加载中..."),$scope.pageNum++,appendGoods($scope.pageNum)}),getCategories=function(){var cat=$rootScope.categories;cat&&cat.length?($scope.categories=cat,$rootScope.initNav(cat)):httpRequest.APIPOST("/goods/category_v1.3",dataStringify("platform=all"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var cat=result.result;$scope.categories=cat,$rootScope.initNav(cat)}else alertWarning(result.msg)})},appendGoods=function(pageNum){var now=(new Date).format("yyyy-mm-dd HH:MM:ss");$scope.isloading=!0;var paramCategory=code?"&category="+code:"",ldToken=$scope.user?"&token="+$scope.user.token:"";httpRequest.APIPOST("/goods/listByCategory",dataStringify("platform=all"+ldToken+paramCategory+"&pageNo="+pageNum+"&pageSize=10&now="+now),{"content-type":"application/x-www-form-urlencoded"},1==pageNum?!0:!1).then(function(result){result&&result.code==statusCode.Success?(pageNum>1?($scope.products=$scope.products.concat(result.result),$scope.pageCount=result.page.totalPage,$scope.pageNum=pageNum):($scope.products=result.result,$scope.pageCount=result.page.totalPage,$scope.pageNum=result.page.pageNo),$scope.isloading=!1):($scope.isloading=!1,alertWarning(result.msg))})};getCategories(),appendGoods(1),$(".scrollable-content").scroll(function(){$("#divProducts").length>0&&0==$scope.isloading&&$scope.pageCount&&advanceLoad("#divProductList",loadObj,$scope.pageNum<$scope.pageCount)}),$scope.inquiry=function(){$location.path("/myProfile")},$scope.goProduct=function(id){return id?void($scope.isApp?window.location.href=easybuy.appActivity+"?action=1&goodId="+id:$location.path("/product/"+id+"/1")):void alertWarning("该商品已经下架，请选择其他商品购买^_^")},$scope.drawProductsPanel=function(){$("#divProducts .list-products-item .products-item-image").css("height",$("#divProducts .list-products-item").width()+"px"),$("#divProducts .list-products-item .products-item-title").css("height",$("#divProducts .list-products-item").width()/1.67+"px"),$("#divProducts .list-products-item .products-item-title .products-item-name").css("height",$("#divProducts .list-products-item").width()/4+"px")},$(window).resize(function(){$scope.drawProductsPanel()}),$scope.cart=function(){$location.path("/cart")},$scope.cartNum=function(){httpRequest.APIPOST("/cart/list_v1.4",dataStringify("platform=all&token="+$rootScope.tokenInfo.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){var num=0;result&&result.code==statusCode.Success?($scope.cartProducts=result.result.normal,num=$scope.cartProducts.length):(alertWarning(result.msg),num=0),$scope.cartQuantity=num})},$scope.cartNum()}),app.controller("searchPanelController",function($rootScope,$scope,httpRequest,dataStringify){$scope.cancelSearch=function(){$scope.$emit("CtrlSearchPanel",!1),$scope.searchKeyword="",$scope.isLocalKey=!0,$scope.isQuery=!1,$scope.queryProducts=[]},$scope.isQuery=!1,$scope.searchKeyword="",$scope.searchLocalItems=getSearchLocalItems()||[],$scope.searchItems=[],$scope.isLocalKey=!0,$scope.searchKeyup=function(){$scope.searchKeyword.length>0?($scope.isLocalKey=!1,$scope.getSuggestKeywords($scope.searchKeyword)):$scope.isLocalKey=!0},$scope.searchFocus=function(){$scope.searchLocalItems.length>0&&$(".search-result").addClass("focus")},$scope.searchBlur=function(){$(".search-result").removeClass("focus")},$scope.saveSearchKeyword=function(value){$scope.searchLocalItems.push({value:value}),setSearchLocalItems($scope.searchLocalItems),$scope.searchKeyword=value,$scope.queryGoods(value,1)},$scope.removeSearchKeyword=function(){setSearchLocalItems(null),$scope.searchLocalItems=[]},$(".search-input").bind("keyup",function(e){13==e.keyCode&&$scope.searchKeyword.length>0&&($scope.searchLocalItems.push({value:$scope.searchKeyword}),setSearchLocalItems($scope.searchLocalItems))}),$scope.getShowKeywords=function(){httpRequest.APIPOST("/keywords/getShow",dataStringify("platform=all"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?$scope.hotKeywords=result.result:alertWarning(result.msg)})},$scope.getShowKeywords(),$scope.getSuggestKeywords=function(q){httpRequest.APIPOST("/solr/keywords/suggest",dataStringify("platform=all&q="+q),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.searchItems=result.result,$scope.searchItems.length>0?$(".search-result").addClass("focus"):$(".search-result").removeClass("focus")):alertWarning(result.msg)})},$scope.queryGoods=function(q,pageNo){$scope.searchKeyword=q,httpRequest.APIPOST("/solr/goods/query",dataStringify("platform=all&q="+q+"&pageNo="+pageNo+"&pageSize=10"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.isQuery=!0,pageNo>1?($scope.queryProducts=$scope.queryProducts.concat(result.result),$scope.queryPageCount=result.page.totalPage,$scope.queryPageNum=pageNo):($scope.queryProducts=result.result,$scope.queryPageCount=result.page.totalPage,$scope.queryPageNum=result.page.pageNo)):alertWarning(result.msg)})};var loadObj=new loadControl("#queryLoadCanvas",function(){$(".pull-loading").html("加载中..."),$scope.queryPageNum++,$scope.queryGoods($scope.searchKeyword,$scope.queryPageNum)});$(".scrollable-content").scroll(function(){$("#queryProducts").length>0&&$scope.queryPageCount&&advanceQueryLoad("#queryProductList",loadObj,$scope.queryPageNum<$scope.queryPageCount)}),$scope.drawQueryPanel=function(){$("#queryProducts .list-products-item .products-item-image").css("height",$("#queryProducts .list-products-item").width()+"px"),$("#queryProducts .list-products-item .products-item-title").css("height",$("#queryProducts .list-products-item").width()/1.67+"px"),$("#queryProducts .list-products-item .products-item-title .products-item-name").css("height",$("#queryProducts .list-products-item").width()/4+"px")},$(window).resize(function(){$scope.drawQueryPanel()})}),app.controller("productAppController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.$on("CtrlDownloadShow",function(event,show){$scope.showDownload=show}),$scope.isGo=function(){return!1},httpRequest.APIPOST("/goods/detail",dataStringify("platform=all&id="+$routeParams.id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success&&($scope.product=result.result,$scope.product)){if($scope.product.num=1,$scope.product.imgs&&$scope.product.imgs.length>0){$(".pager_control").removeClass("hide"),1==$scope.product.favorite&&$(".div-favorite img").attr("src","image/icon_favorite_hover.png"),$(".product-content").html($scope.product.description),$(".product-content").find("img").unbind("click").bind("click",function(){showImageLarger(this)});var control=navigator.control||{};control.gesture&&control.gesture(!1),$scope.product.avgStar=$scope.product.avgStar?$scope.product.avgStar:0,$scope.product.commentNum>0&&($(".rateTotal").raty({path:"image/raty",size:15,score:$scope.product.avgStar,readOnly:!0}),$(".itemRate").raty({path:"image/raty",size:15,score:$scope.product.comment.star,readOnly:!0}))}"undefined"==typeof IScroll?$.ajax({url:"/lib/iscroll.js",dataType:"script",cache:!0,success:function(){$scope.initScroll()}}):$scope.initScroll()}}),$scope.back=function(){1==history.length||$location.search().version?$location.path("/products"):history.back()},$scope.addToCart=function(goodsNum){return 0>=goodsNum?void alertWarning("库存已不足，请稍后购买"):($(".promotePriceNewTotal").html("￥"+$scope.product.promotePrice),void openPrompt("addToCart",function(num){var product=$.extend(!0,{},$scope.product);product.num=num;var data="platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+product.id+"&quantity="+num;httpRequest.APIPOST("/cart/add",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success&&(setCart(null),setCart(result.result.normal),closeDialog(),$scope.cartNum(),alertSuccess("加入成功"))})}))},$scope.reduceNum=function(goods){goods.num>1&&goods.num--},$scope.addNum=function(goods){goods.num++},$scope.validNum=function(goods,allowEmpty){if(goods.num=validInteger(goods.num),!allowEmpty||""!=goods.num){var num=parseInt(goods.num);goods.num=isNaN(num)||1>num?1:num}},$scope.go=function(goodsNum){return 0>=goodsNum?void alertWarning("库存已不足，请稍后购买"):void openPrompt("go",function(num){var product=$.extend(!0,{},$scope.product);product.num=num,$scope.product&&(closeDialog(),$location.path("/pay/999").search({goodsId:product.id,quantity:num}),$scope.$apply($location))})},$scope.viewComments=function(){$scope.product&&$scope.product.commentNum>0&&$location.path("/comment/"+$routeParams.id)},$scope.initScroll=function(){for(var i=0;i<$scope.product.imgs.length;i++){var img=$scope.product.imgs[i],p=$scope.product,$img=$("<img />");$img.attr("src",img),$img.attr("title",p.title);var $slide=$('<div class="slide"></div>').append($img);$("#scroller").append($slide),$("#indicator").css("width",15*$scope.product.imgs.length-5+"px"),$(".slide").css("width",100/$scope.product.imgs.length+"%"),$("#scroller").css("width",100*$scope.product.imgs.length+"%")}$("#spanCurrPage").html(1),$("#spanTotalsCount").html($scope.product.imgs.length),$scope.myScroll=null,$scope.myScroll=new IScroll("#wrapper",{scrollX:!0,scrollY:!1,momentum:!1,preventDefault:!1,snap:!0,snapSpeed:100,keyBindings:!0,indicators:{el:document.getElementById("indicator"),resize:!1}});var handler=function(e){e.preventDefault()};$scope.myScroll.on("scrollStart",function(){$("#viewport")[0].addEventListener("touchmove",handler,!1)}),$scope.myScroll.on("scrollEnd",function(){$("#spanCurrPage").html($scope.myScroll.currentPage.pageX+1),$("#viewport")[0].removeEventListener("touchmove",handler,!1)})},$scope.cart=function(){$location.path("/cart")},$scope.cartNum=function(){httpRequest.APIPOST("/cart/list_v1.4",dataStringify("platform=all&token="+$rootScope.tokenInfo.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){var num=0;result&&result.code==statusCode.Success?($scope.cartProducts=result.result.normal,num=$scope.cartProducts.length):(alertWarning(result.msg),num=0),$scope.cartQuantity=num})},$scope.cartNum()}),app.controller("commentController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){function appendComments(pageNum){$scope.isloading=!0,httpRequest.APIPOST("/goods/listComment",dataStringify("platform=all&goodsId="+$routeParams.id+"&pageNo="+pageNum+"&pageSize=15"+(pageNum>1?"&now="+$scope.pageTime:"")),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if($scope.isloading=!1,result&&result.code==statusCode.Success){$scope.commentInfo=result.result,$scope.page=result.page,$scope.commentInfo&&$(".rateTotal img").length<1&&$(".rateTotal").raty({path:"image/raty",size:15,score:$scope.commentInfo.avgStar,readOnly:!0});var comments=$scope.commentInfo.comments;if(comments){var index=0;$scope.comments?(index=$scope.comments.length,$scope.comments=$scope.comments.concat(comments)):$scope.comments=comments,setTimeout(function(){$scope.$apply($scope.comments),$.each($(".product-item-comment"),function(i,item){$(item).find(".itemRate img").length<1&&$(item).find(".itemRate").raty({path:"image/raty",size:15,score:parseInt($(item).find(".itemRate").attr("score")),readOnly:!0})})},0)}}loadObj.clear(),$(".pull-loading").html("上拉加载")})}$scope.pageNum=1,appendComments($scope.pageNum);var loadObj=new loadControl("#myLoadCanvas",function(){$(".pull-loading").html("加载中..."),$scope.pageNum++,appendComments($scope.pageNum)});$(".scrollable-content").scroll(function(){$("#divProductComments").length>0&&0==$scope.isloading&&$scope.page&&advanceLoadCommon("#divProductComments",loadObj,$scope.pageNum<$scope.page.totalPage)})}),app.controller("downloadController",function($rootScope,$scope,httpRequest,analytics,$location,$window,$routeParams){$scope.type=$routeParams.type,$scope.ProgramTypes=easybuy.ProgramTypes,$scope.mobileType=getMobileType(),$scope.type==$scope.ProgramTypes.APP||getCloseDownloadApp()||($scope.mobileType==MobileTypes.Android&&appDownloadUrl.android&&""!=appDownloadUrl.android?(!isWeixin()||appDownloadUrl.webchat&&""!=appDownloadUrl.webchat)&&($scope.show=!0):($scope.mobileType==MobileTypes.iPhone||$scope.mobileType==MobileTypes.iPad)&&appDownloadUrl.ios&&""!=appDownloadUrl.ios&&(!isWeixin()||appDownloadUrl.webchat&&""!=appDownloadUrl.webchat)&&($scope.show=!0)),$scope.$emit("CtrlDownloadShow",$scope.show);var isXiaoMiBrowser=function(){var ua=navigator.userAgent.toLowerCase();return"miuibrowser"==ua.match(/miuibrowser/i)?!0:!1};$scope.download=function(){isWeibo()||(window.location.href=easybuy.appOpenUrl),$scope.mobileType==MobileTypes.Android&&isXiaoMiBrowser()&&(window.location.href=appDownloadUrl.webchat),window.setTimeout(function(){if(isWeixin()){if($scope.mobileType==MobileTypes.Android)window.location.href=appDownloadUrl.webchat;else if($scope.mobileType==MobileTypes.iPhone||$scope.mobileType==MobileTypes.iPad){$scope.mobileType==MobileTypes.iPad;var arrButton=["取消","确定"];openDialog("请点击右上角在浏览器中打开下载","",arrButton,null,function(r){})}}else $scope.mobileType==MobileTypes.Android?window.location.href=isXiaoMiBrowser()?appDownloadUrl.android:appDownloadUrl.webchat:($scope.mobileType==MobileTypes.iPhone||$scope.mobileType==MobileTypes.iPad)&&($scope.mobileType==MobileTypes.iPad?window.open(appDownloadUrl.ios):window.location.href=appDownloadUrl.ios)},500)},$scope.close=function(){$scope.show=!1,setCloseDownloadApp(),$scope.$emit("CtrlDownloadShow",$scope.show)}}),app.controller("cartController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){$scope.products=[],$scope.empty=!1;var cartProducts=[];$scope.totalAmountValue=0,$scope.back=function(){history.back()};for(var length=cartProducts.length,goodsId="",quantity="",checkeds="",i=0;length>i;i++){var chk=cartProducts[i].checked?"1":"0";length-1>i?(goodsId=goodsId+cartProducts[i].id+",",quantity=quantity+cartProducts[i].num+",",checkeds=checkeds+chk+","):(goodsId+=cartProducts[i].id,quantity+=cartProducts[i].num,checkeds+=chk)}$scope.getCart=function(){httpRequest.APIPOST("/cart/list_v1.4",dataStringify("platform=all&token="+$rootScope.tokenInfo.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.products=result.result.normal,$scope.cartInfo=result.result,$scope.empty=$scope.products?$scope.products.length<1?!0:!1:!0):alertWarning(result.msg)})},$scope.getCart(),(getMobileType()==MobileTypes.iPhone||getMobileType()==MobileTypes.iPad)&&(window.onresize=function(){refixNavBottom()},window.onresize()),$scope.reduceNum=function(index){$scope.products[index].quantity--,$scope.synCart},$scope.addNum=function(index){$scope.products[index].quantity++,$scope.totalAmount()},$scope.validNum=function(index){$scope.products[index].quantity=""==validInteger($scope.products[index].quantity)?0:parseInt(validInteger($scope.products[index].quantity)),$scope.totalAmount()},$scope.checked=function(product,parentIndex,index){product.checked=product.checked?0:1,$scope.updateStatus(),$scope.totalAmount(parentIndex,index)},$scope.totalNum=function(){var totalNum=0;if($scope.products)for(var i=0;i<$scope.products.length;i++)$scope.products[i].checked&&(totalNum+=parseInt($scope.products[i].quantity)?parseInt($scope.products[i].quantity):0);return totalNum},$scope.isAllChecked=function(){if(null==$scope.products||0==$scope.products.length)return!1;for(var i=0;i<$scope.products.length;i++)if(null==$scope.products[i].checked||!$scope.products[i].checked)return!1;return!0},$scope.checkAll=function(){if($scope.products&&$scope.products.length>0)for(var isAllChecked=$scope.isAllChecked(),i=0;i<$scope.products.length;i++)$scope.products[i].checked=!isAllChecked;$scope.updateStatus(),$scope.totalAmount()},$scope.go=function(){return 0==$scope.totalNum()?void alertWarning("您还没有选择商品哦"):void $scope.synCart()},$scope.edit=function(){$scope.editMode=!0},$scope.done=function(){$scope.editMode=!1,$scope.totalAmount()},$scope.remove=function(){if(0==$scope.totalNum())return void alertWarning("请选中您要删除的商品");var arrButton=["取消","确定"];openDialog("确认从购物袋中删除所有选中的商品？","删除商品",arrButton,null,function(r){if(r){for(var goodsIds=[],i=0;i<$scope.products.length;i++)$scope.products[i].checked&&goodsIds.push($scope.products[i].id);var data="platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+goodsIds.join(",");httpRequest.APIPOST("/cart/delete",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success&&$scope.getCart()})}})},$scope.totalAmount=function(){$scope.totalAmountValue=0;for(var goodsIds=($scope.products,[]),goodsQuantity=[],i=0;i<$scope.products.length;i++)$scope.products[i].checked&&(goodsIds.push($scope.products[i].id),goodsQuantity.push($scope.products[i].quantity));return 0==goodsIds.length?($scope.cartInfo.total=0,$scope.cartInfo.oldTotal=0,void($scope.cartInfo.js=0)):void httpRequest.APIPOST("/cart/price_v1.4",dataStringify("platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+goodsIds.join(",")+"&quantity="+goodsQuantity.join(",")),{"content-type":"application/x-www-form-urlencoded"},!0).then(function(result){result&&result.code==statusCode.Success?($scope.totalAmountValue=0,$scope.cartInfo=result.result):alert(result.msg)})},$scope.synCart=function(){for(var goodsIds=[],goodsQuantity=[],checkeds=[],i=0;i<$scope.products.length;i++)checkeds.push($scope.products[i].checked?1:0),goodsIds.push($scope.products[i].id),goodsQuantity.push($scope.products[i].quantity);var data="platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+goodsIds.join(",")+"&quantity="+goodsQuantity.join(",");httpRequest.APIPOST("/cart/update",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success})},$scope.updateStatus=function(){for(var goodsIds=[],checkeds=[],i=0;i<$scope.products.length;i++)checkeds.push($scope.products[i].checked?1:0),goodsIds.push($scope.products[i].id);var data="platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+goodsIds.join(",")+"&checked="+checkeds.join(",");httpRequest.APIPOST("/cart/status",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success})}}),app.controller("addressController",function($rootScope,$scope,dataStringify,httpRequest,analytics,$location,$window,$routeParams){function initArea(){$("#agentRegion").val($scope.addressInfo.region).attr("data",$scope.addressInfo.regionIds),$("#pAddress").mobiscroll().treelist({theme:"android-ics light",display:"modal",mode:"scroller",labels:["省份","城市"],setText:"确认",cancelText:"取消",width:"90",insertTo:"#agentRegion",action:"fillParentCity"}),$("#pAddress_dummy").css("display","none"),$("#agentRegion").click(function(){return $("#pAddress_dummy").click(),!1})}if($scope.buyType=parseInt($routeParams.buyType)||1,$location.$$search.token)showLoading(),httpRequest.APIPOST("/address/default",dataStringify("platform=all&token="+$location.$$search.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg)if($scope.addressInfo=result.result,$scope.addressInfo&&$scope.addressInfo.returnDate&&($scope.time=$scope.addressInfo.returnDate+" "+$scope.addressInfo.returnTime),$scope.addressInfo?$scope.addressInfo.province&&($scope.addressInfo.region=$scope.addressInfo.province+" "+$scope.addressInfo.city+" "+$scope.addressInfo.district,$scope.addressInfo.regionIds=$scope.addressInfo.provinceId+","+$scope.addressInfo.cityId+","+$scope.addressInfo.districtId):$scope.addressInfo={},2==$scope.buyType)initArea();else{setAddressTemp($scope.addressInfo);var startdate=new Date;startdate.setHours(startdate.getHours()+1);var m=startdate.getMinutes()%5;0!=m&&startdate.setMinutes(startdate.getMinutes()+(5-m)),startdate.setSeconds(0),startdate.setMilliseconds(0),$scope.minDateTime=startdate;var enddate=new Date;enddate.setMonth(enddate.getMonth()+6),enddate.setHours(23),enddate.setMinutes(59),enddate.setSeconds(59),enddate.setMilliseconds(999),$scope.maxDateTime=enddate,opt.datetime={dateOrder:"yymmdd",dateFormat:"yyyy-mm-dd",preset:"datetime",minDate:startdate,maxDate:enddate,stepMinute:5,onSelect:function(){$scope.saveTemp(),$scope.time=$("#appDateTime").val(),event.stopPropagation()}};{var optDateTime=$.extend(opt.datetime,opt.Default);$.extend(opt.time,opt.Default)}$("#appDateTime").mobiscroll(optDateTime).date(optDateTime)}else alertWarning(result.msg)});else if(2==$scope.buyType)initArea();else{var startdate=new Date;startdate.setHours(startdate.getHours()+1);var m=startdate.getMinutes()%5;0!=m&&startdate.setMinutes(startdate.getMinutes()+(5-m)),startdate.setSeconds(0),startdate.setMilliseconds(0),$scope.minDateTime=startdate;var enddate=new Date;enddate.setMonth(enddate.getMonth()+6),enddate.setHours(23),enddate.setMinutes(59),enddate.setSeconds(59),enddate.setMilliseconds(999),$scope.maxDateTime=enddate,opt.datetime={dateOrder:"yymmdd",dateFormat:"yyyy-mm-dd",preset:"datetime",minDate:startdate,maxDate:enddate,stepMinute:5,onSelect:function(){$scope.saveTemp(),$scope.time=$("#appDateTime").val(),$scope.search(),event.stopPropagation()}};{var optDateTime=$.extend(opt.datetime,opt.Default);$.extend(opt.time,opt.Default)}$("#appDateTime").mobiscroll(optDateTime).date(optDateTime)}$scope.back=function(){clearAddressTemp(),history.back()},$scope.date=function(){$("#appDateTime").mobiscroll("show")},$scope.validNum=function(){$scope.addressInfo.mobile=validInteger($scope.addressInfo.mobile)},$scope.saveTemp=function(){$scope.addressInfo||($scope.addressInfo={}),2==$scope.buyType?($scope.addressInfo.region=$("#agentRegion").val(),$scope.addressInfo.regionIds=$("#agentRegion").attr("data")):$scope.addressInfo.returnTime=$("#appDateTime").val(),setAddressTemp($scope.addressInfo)},$scope.search=function(callback){var flightNo=$scope.addressInfo.returnFlightno;if(void 0==flightNo&&(flightNo=""),flightNo.length>=2&&$scope.time){var data="platform=all&backFlightno="+flightNo+"&backDate="+$scope.time;httpRequest.APIPOST("/flight/back",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.addressInfo.returnAirportId=result.result.returnAirportId,$scope.addressInfo.returnAirport=result.result.returnAirport,$scope.addressInfo.returnTime=result.result.returnTime,$scope.time||($scope.time=""),$("#appDateTime").val($scope.time.split(" ")[0]+" "+result.result.returnTime),$scope.time=$scope.time.split(" ")[0]+" "+result.result.returnTime,$scope.saveTemp(),callback()):($scope.addressInfo.returnAirportId=-1,$scope.addressInfo.returnAirport="",alertWarning(result.msg))})}},$scope.save=function(){if(1==$scope.buyType){if(!$scope.addressInfo.contact||""==$scope.addressInfo.contact.toString().trim())return void alertWarning("请填写联系人姓名");if($scope.addressInfo.contact.toString().length<2||$scope.addressInfo.contact.toString().length>20)return void alertWarning("请输入2~20位的联系人姓名");if(!$scope.addressInfo.mobile||""==$scope.addressInfo.mobile)return void alertWarning("请填写手机号码");if($scope.addressInfo.mobile.toString().length<9||$scope.addressInfo.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");var flightTime=$("#appDateTime").val();if(!flightTime||""==flightTime)return void alertWarning("请选择回程日期");if($scope.addressInfo.returnTime=flightTime,!$scope.addressInfo.returnFlightno||""==$scope.addressInfo.returnFlightno)return void alertWarning("请输入回程航班号");if(new Date(flightTime.replace(/-/g,"/"))<$scope.minDateTime)return void alertWarning("起飞时间请选择1小时后")}else{if(!$scope.addressInfo.contact||""==$scope.addressInfo.contact.toString().trim())return void alertWarning("请填写收货人姓名");if($scope.addressInfo.contact.toString().length<2||$scope.addressInfo.contact.toString().length>20)return void alertWarning("请输入2~20位的收货人姓名");if(!$scope.addressInfo.mobile||""==$scope.addressInfo.mobile)return void alertWarning("请填写手机号码");if($scope.addressInfo.mobile.toString().length<9||$scope.addressInfo.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");if(0==$("#agentRegion").val().trim().length)return void alertWarning("请选择所在地");if($scope.addressInfo.region=$("#agentRegion").val(),!$scope.addressInfo.detailAddress||""==$scope.addressInfo.detailAddress.toString().trim())return void alertWarning("请填写详细地址");if($scope.addressInfo.detailAddress.toString().length<5||$scope.addressInfo.detailAddress.toString().length>60)return void alertWarning("请输入5~60位的收货地址")}$scope.search(function(){var data="";if(2==$scope.buyType){var arrRegion=$("#agentRegion").attr("data").split(",");data="platform=all&token="+$location.$$search.token+"&contact="+$scope.addressInfo.contact+"&cityId="+arrRegion[1]+"&detailAddress="+$scope.addressInfo.detailAddress+"&provinceId="+arrRegion[0]+"&districtId="+arrRegion[2]+"&mobile="+$scope.addressInfo.mobile}else data="platform=all&token="+$location.$$search.token+"&returnTime="+$scope.addressInfo.returnTime+"&contact="+$scope.addressInfo.contact+"&returnAirportId="+$scope.addressInfo.returnAirportId+"&mobile="+$scope.addressInfo.mobile+"&returnFlightno="+$scope.addressInfo.returnFlightno;httpRequest.APIPOST("/address/add",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(clearAddressTemp(),history.back()):alertWarning(result.msg)})})}}),app.controller("airportController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){httpRequest.APIPOST("/dic/listFlight",dataStringify("platform=all&type=2"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){var flights=result.result;$scope.flights=[];for(var i=0;i<flights.length;i++)$scope.flights.push({id:flights[i].id,terminal:flights[i].name});if($scope.flights&&null!=$routeParams.id)for(var i=0;i<$scope.flights.length;i++)if($scope.flights[i].id==$routeParams.id){$scope.flights[i].selected=!0;break}}else alertWarning(result.msg)}),$scope.select=function(flight){if($scope.flights&&$scope.flights.length>0)for(var i=0;i<$scope.flights.length;i++)$scope.flights[i].selected=!1;flight.selected=!0;var addressInfo=getAddressTemp();null==addressInfo&&(addressInfo=new Object),addressInfo.flight_id=flight.id,addressInfo.terminal=flight.terminal,setAddressTemp(addressInfo),history.back()},$scope.isSelected=function(){if($scope.flights&&$scope.flights.length>0)for(var i=0;i<$scope.flights.length;i++)if($scope.flights[i].selected)return!0;return!1}}),app.controller("orderInquiryController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){if(easybuy.parameter.mobileInquiry&&($scope.mobile=easybuy.parameter.mobileInquiry),!$scope.mobile){var userInfo=getUserInfo();userInfo&&($scope.mobile=userInfo.mobile)}$scope.validNum=function(){$scope.mobile=validInteger($scope.mobile)},$scope.inquiry=function(){return $scope.mobile&&""!=$scope.mobile?$scope.mobile.toString().length<9||$scope.mobile.toString().length>13?void alertWarning("请输入9~13位的手机号"):(easybuy.parameter.mobileInquiry=$scope.mobile,void $location.path("/orderList/"+$scope.mobile)):void alertWarning("请填写手机号")}}),app.controller("orderListController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.token=$routeParams.token,$scope.orders=[],$scope.go=function(){$location.path("/products")},$scope.getOrderStatus=function(status){return 1==status?"等待付款":2==status?"等待确认收货":3==status?"交易成功":4==status?"已取消":5==status?"退款中":6==status?"已退款":7==status?"已失效":void 0};var tokenInfo=getToken();tokenInfo&&tokenInfo.token||(tokenInfo={},tokenInfo.token="");var pageNo=1,pageSize=100,token=$scope.token?$scope.token:tokenInfo.token;showLoading(),httpRequest.APIPOST("/orderLd/list",dataStringify("platform=all&token="+token+"&category=1&pageNo="+pageNo+"&pageSize="+pageSize),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?($scope.orders=result.result,hideLoading(),$scope.orders&&$scope.orders.length<1&&($scope.orders=null)):(hideLoading(),alert(result.msg))}),$scope.Payments=easybuy.Payments;for(var isChecked=!1,i=$scope.Payments.length-1;i>=0;i--)$scope.Payments[i].id!=easybuy.PaymentMethods.WechatPay||easybuy.isWechat?$scope.Payments[i].checked&&(isChecked=!0):$scope.Payments.splice(i,1);isChecked||$.each($scope.Payments,function(i,item){return item.id==easybuy.PaymentMethods.AlipayWeb?(item.checked=!0,!1):void 0}),$scope.pay=function(orderNum,totalPrice,address,returnTime,id){httpRequest.APIPOST("/order/checkDate",dataStringify("platform=all&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){address||(address=1),returnTime||(returnTime=2);var arrButton=["取消","确定"];openDialog("确认从购物袋中删除所有选中的商品？","支付方式",arrButton,4,function(r,pWay){if(r)if(pWay==easybuy.PaymentMethods.WechatPay)window.location.href=serviceUrl+"/order/pay/orderid/"+orderNum+"/amount/"+totalPrice+"/address/"+address+"/time/"+returnTime;else if(easybuy.isWechat){var url=$location.absUrl().split("#")[0]+"#/dividedPay/"+orderNum+"/"+totalPrice;window.location.href=url}else window.location.href=paymentUrl+"callback=1&out_trade_no="+orderNum+"&total_fee="+totalPrice})}else alertWarning(result.msg)})},$scope.deleteOrder=function(id){var arrButton=["取消","确定"];openDialog("确认删除当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/delete",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("删除成功！"),httpRequest.APIPOST("/order/list",dataStringify("platform=all&token="+token+"&category=1&pageNo="+pageNo+"&pageSize="+pageSize),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?($scope.orders=result.result,hideLoading(),$scope.orders&&$scope.orders.length<1&&($scope.orders=null)):(hideLoading(),alert(result.msg))})):(hideLoading(),alert(result.msg))}))})},$scope.cancelOrder=function(id,index){var arrButton=["取消","确定"];openDialog("确认取消当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/cancel",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("取消成功！"),$scope.orders[index].status=4):(hideLoading(),alert(result.msg))}))})},$scope.takeOverOrder=function(id,index){showLoading(),httpRequest.APIPOST("/order/confirm",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("收货成功！"),$scope.orders[index].status=3):(hideLoading(),alert(result.msg))})},$scope.back=function(){$location.path("/myProfile")}}),app.controller("orderDetailController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){function checkToken(){return!token||token&&token.length<12?!1:!0
}$scope.orderId=$routeParams.id,$scope.token=$routeParams.token,$scope.totalNum=0,$scope.totalAmount=0;var token=$scope.token;$scope.getOrderStatus=function(status,category){return 1==status?"等待付款":2==status&&category&&3==category?"进行中":2==status&&3!=category?"等待确认收货":3==status&&category&&3==category?"交易成功":3==status&&3!=category?"交易成功":4==status?"订单已取消":5==status&&3!=category?"退款中":6==status&&3!=category?"退款成功":7==status?"已失效":void 0},$scope.deleteOrder=function(id){var tokenInfo=getToken();if(tokenInfo&&tokenInfo.token){token=tokenInfo.token;var arrButton=["取消","确定"];openDialog("确认删除当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/delete",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("删除成功！"),$location.path("/orderList/"+token)):(hideLoading(),alert(result.msg))}))})}else $location.path(easybuy.isWechat?"/wechatOauth/orderDetail-"+$routeParams.id:"/myProfile/orderDetail-"+$routeParams.id)},$scope.drawbackOrder=function(id){if(checkToken()){var arrButton=["取消","确定"];openDialog("确认退款？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/refund",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("退款成功！"),$scope.order.status=5):(hideLoading(),alert(result.msg))}))})}else{var tokenInfo=getToken();if(tokenInfo&&tokenInfo.token){token=tokenInfo.token;var arrButton=["取消","确定"];openDialog("确认退款？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/refund",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("退款成功！"),$scope.order.status=5):(hideLoading(),alert(result.msg))}))})}else $location.path(easybuy.isWechat?"/wechatOauth/orderDetail-"+$routeParams.id:"/myProfile/orderDetail-"+$routeParams.id)}},$scope.cancelOrder=function(id){if(checkToken()){var arrButton=["取消","确定"];openDialog("确认取消当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/cancel",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("取消成功！"),$scope.order.status=4):(hideLoading(),alert(result.msg))}))})}else{var tokenInfo=getToken();if(tokenInfo&&tokenInfo.token){token=tokenInfo.token;var arrButton=["取消","确定"];openDialog("确认取消当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/order/cancel",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("取消成功！"),$scope.order.status=4):(hideLoading(),alert(result.msg))}))})}else $location.path(easybuy.isWechat?"/wechatOauth/orderDetail-"+$routeParams.id:"/myProfile/orderDetail-"+$routeParams.id)}},$scope.takeOverOrder=function(id){if(checkToken())showLoading(),httpRequest.APIPOST("/order/confirm",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("收货成功！"),$scope.order.status=3):(hideLoading(),alert(result.msg))});else{var tokenInfo=getToken();tokenInfo&&tokenInfo.token?(token=tokenInfo.token,showLoading(),httpRequest.APIPOST("/order/confirm",dataStringify("platform=all&token="+token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("收货成功！"),$scope.order.status=3):(hideLoading(),alert(result.msg))})):$location.path(easybuy.isWechat?"/wechatOauth/orderDetail-"+$routeParams.id:"/myProfile/orderDetail-"+$routeParams.id)}},!$scope.orderId&&getUserInfo()&&($scope.addressInfo=getUserInfo(),$scope.mobile=$scope.addressInfo.mobile),$scope.orderId?httpRequest.APIPOST("/orderLd/detail",dataStringify("platform=all&&orderId="+$scope.orderId+"&token="+$scope.tokenInfo.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){if($scope.order=result.result,$scope.order&&$scope.order.goodsList&&$scope.order.goodsList.length>0){for(var i=0;i<$scope.order.goodsList.length;i++)$scope.order.goodsList[i].quantity=parseInt($scope.order.goodsList[i].quantity),$scope.totalNum+=$scope.order.goodsList[i].quantity,$scope.totalAmount+=$scope.order.goodsList[i].quantity*$scope.order.goodsList[i].buyPrice;"''"==$scope.order.comments&&($scope.order.comments="")}}else alert(result.msg)}):$scope.order=!1,$scope.showLarge=function(imgUrl){showLargeImage(imgUrl)},$scope.go=function(){$location.path("/products")},$scope.Payments=easybuy.Payments;for(var isChecked=!1,i=$scope.Payments.length-1;i>=0;i--)$scope.Payments[i].id!=easybuy.PaymentMethods.WechatPay||easybuy.isWechat?$scope.Payments[i].checked&&(isChecked=!0):$scope.Payments.splice(i,1);isChecked||$.each($scope.Payments,function(i,item){return item.id==easybuy.PaymentMethods.AlipayWeb?(item.checked=!0,!1):void 0}),$scope.pay=function(orderNum,totalPrice,address,returnTime,id){httpRequest.APIPOST("/order/checkDate",dataStringify("platform=all&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){var arrButton=["取消","确定"];address||(address=1),returnTime||(returnTime=2),openDialog("确认从购物袋中删除所有选中的商品？","支付方式",arrButton,4,function(r,pWay){if(r)if(pWay==easybuy.PaymentMethods.WechatPay)window.location.href=serviceUrl+"/order/pay/orderid/"+orderNum+"/amount/"+totalPrice+"/address/"+address+"/time/"+returnTime;else if(easybuy.isWechat){var url=$location.absUrl().split("#")[0]+"#/dividedPay/"+orderNum+"/"+totalPrice;window.location.href=url}else window.location.href=paymentUrl+"callback=1&out_trade_no="+orderNum+"&total_fee="+totalPrice})}else alertWarning(result.msg)})},$scope.back=function(){var data=getToken();$location.path(data&&data.token?"/orderList/"+data.token:"/orderList")}}),app.controller("airportServiceController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){function appendComments(pageNum){$scope.isloading=!0,httpRequest.APIPOST("/airportSave/listComment",dataStringify("platform=all&objectId=1&pageNo="+pageNum+"&pageSize=10"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if($scope.isloading=!1,result&&result.code==statusCode.Success){$scope.commentInfo=result.result,$scope.page=result.page,$scope.commentInfo&&$(".rateTotal").raty({path:"image/raty",size:15,score:$scope.commentInfo.commentScore,readOnly:!0});var comments=$scope.commentInfo.comments;if(comments){var index=0;$scope.comments?(index=$scope.comments.length,$scope.comments=$scope.comments.concat(comments)):$scope.comments=comments,setTimeout(function(){$scope.$apply($scope.comments),$.each($(".product-item-comment:eq("+index+")").nextAll().andSelf(),function(i,item){$(item).find(".itemRate").raty({path:"image/raty",size:15,score:parseInt($(item).find(".itemRate").attr("score")),readOnly:!0}),$(item).find(".itemRate").css("width","100%")})},0)}}loadObj.clear(),$(".pull-loading").html("上拉加载")})}var isInApp=isApp($location);$scope.price="10.00",$scope.promotePrice="0",$scope.isloading=!0,httpRequest.APIPOST("/airportSave/info",dataStringify("platform=all"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){$scope.isloading=!1,result&&result.code==statusCode.Success&&($scope.price=result.result.price,$scope.promotePrice=result.result.promotePrice,$scope.airportSaveInfo=result.result,$("#description").html(result.result.description),$("#contact").html(result.result.contact),$("#serviceScope").html(result.result.serviceScope),$("#express").html(result.result.courier))}),$scope.isInApp=isInApp?!0:!1,$scope.needService=function(){return isInApp?void(window.location.href=easybuy.appActivity+"?action=2001&price="+$scope.price+"&promotePrice="+$scope.promotePrice):void $location.path("/airportServiceOrder").search({price:$scope.price,promotePrice:$scope.promotePrice})},$scope.back=function(){$location.path("/products")},$scope.isCollapse=!1,$scope.collapseComments=function(){$scope.isCollapse=$scope.isCollapse?!1:!0},$scope.pageNum=1,appendComments($scope.pageNum);var clientH=$(window).height(),maxHeight=0;$(".tab-content .tab-pane").each(function(i,e){var t=$(e).height();t>maxHeight&&(maxHeight=t)}),$(".tab-content .tab-pane").css("overflow-y","auto"),$(".tab-content .tab-pane").css("padding-bottom","50px"),$(".tab-content .tab-pane").height(clientH-145),$scope.changeTab=function(){},$(".scrollable-content").scroll(50,function(){})}),app.controller("airportServiceOrderController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){function oauthCallback(token){showLoading(),httpRequest.APIPOST("/address/default",dataStringify("platform=all&token="+token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){$scope.addressInfo=result.result;var addressInfo={},addressInfo2=getAddressTemp();null==addressInfo2&&(addressInfo2=getUserInfoService()),addressInfo=$scope.addressInfo,addressInfo2&&(addressInfo2.shopName&&(addressInfo.shopName=addressInfo2.shopName),addressInfo2.shopPhone&&(addressInfo.shopPhone=addressInfo2.shopPhone)),$scope.days=0;var startdate=new Date;startdate.setHours(startdate.getHours()+48);var m=startdate.getMinutes()%5;0!=m&&startdate.setMinutes(startdate.getMinutes()+(5-m)),startdate.setSeconds(0),startdate.setMilliseconds(0),$scope.minDateTime=startdate;var enddate=new Date;enddate.setMonth(enddate.getMonth()+6),enddate.setHours(23),enddate.setMinutes(59),enddate.setSeconds(59),enddate.setMilliseconds(999),$scope.maxDateTime=enddate,opt.datetime={dateOrder:"yymmdd",dateFormat:"yyyy-mm-dd",preset:"datetime",minDate:startdate,maxDate:enddate,stepMinute:5,onSelect:function(){$scope.saveTemp(),$scope.time=$("#appDateTime").val(),event.stopPropagation()}};{var optDateTime=$.extend(opt.datetime,opt.Default);$.extend(opt.time,opt.Default)}$("#appDateTime").mobiscroll(optDateTime).date(optDateTime),addressInfo&&(fillAddressInputs(addressInfo),setAddressTemp(generateAddressTemp($scope,"#appDateTime","#agentRegion")))}else alertWarning(result.msg)})}function fillAddressInputs(addressInfo){if(addressInfo){if(addressInfo.nick_name&&($scope.name=addressInfo.nick_name),addressInfo.take_off_time){$scope.time=addressInfo.take_off_time,$("#appDateTime").val(addressInfo.take_off_time);var enddate=new Date(addressInfo.take_off_time.replace(/-/g,"/"));$scope.days=countDays(enddate),$scope.days=$scope.days<0?0:$scope.days,$scope.$apply($scope.days),$scope.returnDate=addressInfo.take_off_time.split(" ")[0],$scope.returnTime=addressInfo.take_off_time.split(" ")[1]}if(addressInfo.returnTime){$scope.time=addressInfo.returnDate+" "+addressInfo.returnTime,$("#appDateTime").val($scope.time);var enddate=new Date($scope.time.replace(/-/g,"/"));$scope.days=countDays(enddate),$scope.days=$scope.days<0?0:$scope.days,$scope.$apply($scope.days),$scope.returnDate=addressInfo.returnDate,$scope.returnTime=addressInfo.returnTime}addressInfo.contact&&($scope.name=addressInfo.contact),addressInfo.mobile&&($scope.mobile=addressInfo.mobile),addressInfo.agentComment&&($scope.agentComment=addressInfo.agentComment),addressInfo.returnAirportId&&($scope.returnAirportId=addressInfo.returnAirportId,$scope.returnAirport=addressInfo.returnAirport),addressInfo.returnFlightno&&($scope.returnFlightno=addressInfo.returnFlightno),addressInfo.shopName&&($scope.shopName=addressInfo.shopName),addressInfo.shopPhone&&($scope.shopPhone=addressInfo.shopPhone)}}var user=$location.$$search,countDays=function(enddate){var now=new Date;return now.setHours(0),now.setMinutes(0),now.setSeconds(0),now.setMilliseconds(0),enddate.setHours(0),enddate.setMinutes(0),enddate.setSeconds(0),enddate.setMilliseconds(0),enddate.diff(now)},param=$location.search();if(param&&(!param||param.price&&param.promotePrice)?($scope.promotePrice=param.promotePrice,$scope.price=param.price-param.promotePrice):httpRequest.APIPOST("/airportSave/info",dataStringify("platform=all"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){$scope.isloading=!1,result&&result.code==statusCode.Success&&($scope.price=parseFloat(result.result.price)-parseFloat(result.result.promotePrice),$scope.promotePrice=parseFloat(result.result.promotePrice))}),user.openId&&4!=user.source){var source=user.source,data="platform=all&openid="+user.openId+"&nickname="+user.nickname+"&gender=0&avatar="+user.headimgurl+"&source="+source+"&channel=H5&appVersion="+easybuy.version;httpRequest.APIPOST("/user/thirdLogin",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.currentUser=result.result,$scope.currentUser.openId=user.openId,$scope.currentUser.source=user.source,$scope.currentUser.nickname=user.nickname,$scope.currentUser.headimgurl=user.headimgurl,setToken($scope.currentUser),null!=$scope.currentUser.mobile&&$scope.currentUser.mobile||(void 0==$scope.currentUser.bind||$scope.currentUser.bind&&1==$scope.currentUser.bind)&&$location.path("/myPhone/0/"+$scope.currentUser.token).search({user:user,state:"airportServiceOrder"}),oauthCallback($scope.currentUser.token)):alert(result.msg)})}else $scope.currentUser=getToken(),$scope.currentUser&&$scope.currentUser.token?(null!=$scope.currentUser.mobile&&$scope.currentUser.mobile||(void 0==$scope.currentUser.bind||$scope.currentUser.bind&&1==$scope.currentUser.bind)&&$location.path("/myPhone/0/"+$scope.currentUser.token).search({user:$scope.currentUser,state:"airportServiceOrder"}),oauthCallback($scope.currentUser.token)):$location.path(easybuy.isWechat?"/wechatOauth/airportServiceOrder":"/myProfile/airportServiceOrder");$scope.date=function(){$("#appDateTime").mobiscroll("show")},$scope.validNum=function(){$scope.mobile=validInteger($scope.mobile)},$scope.search=function(){var flightNo=$scope.returnFlightno;if(void 0==flightNo&&(flightNo=""),flightNo.length>=2&&$scope.time){var data="platform=all&backFlightno="+$scope.returnFlightno+"&backDate="+$scope.time;httpRequest.APIPOST("/flight/back",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.returnAirportId=result.result.returnAirportId,$scope.returnAirport=result.result.returnAirport,$scope.returnTime=result.result.returnTime,$scope.time||($scope.time=""),$("#appDateTime").val($scope.time.split(" ")[0]+" "+result.result.returnTime),$scope.time=$scope.time.split(" ")[0]+" "+result.result.returnTime,$scope.saveTemp()):($scope.returnAirportId=-1,$scope.returnAirport="",alertWarning(result.msg))})}},$scope.saveTemp=function(){setAddressTemp(generateAddressTemp($scope,"#appDateTime","#agentRegion"));var enddate=new Date($("#appDateTime").val().replace(/-/g,"/"));$scope.days=countDays(enddate),$scope.days=$scope.days?$scope.days:0,$scope.$apply($scope.days)},$scope.getFlightTime=function(callback){var flightNo=$scope.returnFlightno;if(void 0==flightNo&&(flightNo=""),flightNo.length>=2&&$scope.time){var data="platform=all&backFlightno="+$scope.returnFlightno+"&backDate="+$scope.time;httpRequest.APIPOST("/flight/back",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.returnAirportId=result.result.returnAirportId,$scope.returnAirport=result.result.returnAirport,$scope.returnTime=result.result.returnTime,$scope.time||($scope.time=""),$("#appDateTime").val($scope.time.split(" ")[0]+" "+result.result.returnTime),$scope.time=$scope.time.split(" ")[0]+" "+result.result.returnTime,$scope.saveTemp(),callback()):($scope.returnAirportId=-1,$scope.returnAirport="",alertWarning(result.msg))})}},$scope.confirmOrder=function(){if(!$scope.name||""==$scope.name.toString().trim())return void alertWarning("请填写联系人姓名");if($scope.name.toString().length<2||$scope.name.toString().length>20)return void alertWarning("请输入2~20位的联系人姓名");if(!$scope.mobile||""==$scope.mobile)return void alertWarning("请填写手机号码");if($scope.mobile.toString().length<9||$scope.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");var flightTime=$("#appDateTime").val();if(!flightTime||""==flightTime)return void alertWarning("请选择回程起飞时间");if(new Date(flightTime.replace(/-/g,"/"))<$scope.minDateTime)return void alertWarning("回程起飞时间请选择48小时后");if(!$scope.returnFlightno||""==$scope.returnFlightno)return void alertWarning("请输入回程航班号");if(!$scope.shopName||""==$scope.shopName)return void alertWarning("请输入商家名称");if(!$scope.shopPhone||""==$scope.shopPhone)return void alertWarning("请输入商家联系电话");if(void 0==$scope.agentComment)$scope.agentComment="";else if($scope.agentComment.length>100)return void alertWarning("请输入100位以内的备注");$scope.getFlightTime(function(){if(!$scope.returnAirportId)return void alertWarning("请输入正确的航班号和选择合理的回程日期");var name="",flightId=1,mobile="",returnFlightno="";name=$scope.name,mobile=$scope.mobile,flightId=$scope.returnAirportId,returnFlightno=$scope.returnFlightno,$scope.isNextStep=!0,setUserInfoService({returnAirport:$scope.returnAirport,returnAirportId:flightId,returnFlightno:returnFlightno,shopName:$scope.shopName,shopPhone:$scope.shopPhone,nick_name:name,mobile:mobile,flight_id:flightId,terminal:$scope.returnAirport,take_off_time:$scope.time,agentComment:$scope.agentComment}),clearAddressTemp(),$scope.returnDate=flightTime.split(" ")[0],$scope.returnTime=flightTime.split(" ").length>1?flightTime.split(" ")[1]:"";$scope.agentComment?"&comments="+$scope.agentComment:""})},$scope.Payments=easybuy.Payments;for(var isChecked=!1,i=$scope.Payments.length-1;i>=0;i--)$scope.Payments[i].id!=easybuy.PaymentMethods.WechatPay||easybuy.isWechat?$scope.Payments[i].checked&&(isChecked=!0):$scope.Payments.splice(i,1);isChecked||$.each($scope.Payments,function(i,item){return item.id==easybuy.PaymentMethods.AlipayWeb?(item.checked=!0,!1):void 0}),$scope.checked=function(payment){$.each($scope.Payments,function(i,item){item.checked=!1}),payment.checked=!0},$scope.needService=function(){if(!$scope.name||""==$scope.name.toString().trim())return void alertWarning("请填写联系人姓名");if($scope.name.toString().length<2||$scope.name.toString().length>20)return void alertWarning("请输入2~20位的联系人姓名");if(!$scope.mobile||""==$scope.mobile)return void alertWarning("请填写手机号码");if($scope.mobile.toString().length<9||$scope.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");var flightTime=$("#appDateTime").val();if(!flightTime||""==flightTime)return void alertWarning("请选择回程起飞时间");if(new Date(flightTime.replace(/-/g,"/"))<$scope.minDateTime)return void alertWarning("回程起飞时间请选择48小时后");if(!$scope.returnFlightno||""==$scope.returnFlightno)return void alertWarning("请输入回程航班号");if(!$scope.shopName||""==$scope.shopName)return void alertWarning("请输入商家名称");if(!$scope.shopPhone||""==$scope.shopPhone)return void alertWarning("请输入商家联系电话");if(void 0==$scope.agentComment)$scope.agentComment="";else if($scope.agentComment.length>100)return void alertWarning("请输入100位以内的备注");if(!$scope.returnAirportId)return void alertWarning("请输入正确的航班号和选择合理的回程日期");var name="",flightId=1,mobile="",returnFlightno="";name=$scope.name,mobile=$scope.mobile,flightId=$scope.returnAirportId,returnFlightno=$scope.returnFlightno,$scope.isNextStep=!0,setUserInfoService({returnAirport:$scope.returnAirport,returnAirportId:flightId,returnFlightno:returnFlightno,shopName:$scope.shopName,shopPhone:$scope.shopPhone,nick_name:name,mobile:mobile,flight_id:flightId,terminal:$scope.returnAirport,take_off_time:$scope.time,agentComment:$scope.agentComment}),clearAddressTemp(),$scope.returnDate=flightTime.split(" ")[0],$scope.returnTime=flightTime.split(" ").length>1?flightTime.split(" ")[1]:"";var payWay=null;if($.each($scope.Payments,function(i,item){return 1==item.checked?(payWay=item.id,!1):void 0}),null==payWay)return void alertWarning("请选择支付方式");if(payWay==easybuy.PaymentMethods.AlipayWallet)return void alertWarning("无法使用支付宝钱包");var comments=$scope.agentComment?"&comments="+$scope.agentComment:"",data="platform=all&token="+$scope.currentUser.token+"&days="+$scope.days+"&contact="+name+"&mobile="+mobile+"&returnTime="+flightTime+"&returnAirportId="+flightId+"&returnFlightno="+returnFlightno+"&shopName="+$scope.shopName+"&shopPhone="+$scope.shopPhone+"&source=2"+comments;httpRequest.APIPOST("/order/addAirportSaveOrder",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(showLoading(),payWay==easybuy.PaymentMethods.WechatPay?window.location.href=serviceUrl+"/order/pay/orderid/"+result.result.orderNum+"/amount/"+result.result.totalPrice+"/address/address/time/returnTime":easybuy.isWechat?window.location.hash="#/dividedPay/"+result.result.orderNum+"/"+result.result.totalPrice:window.location.href=paymentUrl+"callback=1&out_trade_no="+result.result.orderNum+"&total_fee="+result.result.totalPrice):alert(result.msg)})},$scope.back=function(){$scope.isNextStep?$scope.isNextStep=!1:$location.path("/airportService")}}),app.controller("paymentLDController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){$scope.step=1,$scope.toggleOn=!1,$scope.takeoverMethod=1,$scope.toggleTakeover=function(){$scope.toggleOn=$scope.toggleOn?!1:!0};var goodsId=$location.search().goodsId,quantity=$location.search().quantity;$scope.selectTakeover=function(t){$scope.toggleOn=!1,$scope.takeoverMethod=t},$scope.enterAddress=function(s){$scope.step=s,$scope.addressInfo=$.extend(!0,{},$scope.defaultAddress),$("#appDateTime").val($scope.addressInfo.returnDate+" "+$scope.addressInfo.returnTime)},$scope.goodsItems=function(){$scope.step=4},$scope.back=function(){return $scope.step>1?void($scope.step=1):void history.back()},$scope.getOrderPrice=function(){var data="platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+$location.search().goodsId+"&quantity="+$location.search().quantity;httpRequest.APIPOST("/order/price",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?$scope.orderPrice=result.result:alertWarning(result.msg)})},$scope.getDefaultAddress=function(){var data="platform=all&token="+$rootScope.tokenInfo.token;httpRequest.APIPOST("/address/default",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?$scope.defaultAddress=result.result:alertWarning(result.msg)})},$scope.saveDefaultAddress=function(){if(1==$scope.takeoverMethod){if(!$scope.addressInfo.contact||""==$scope.addressInfo.contact.toString().trim())return void alertWarning("请填写联系人姓名");if($scope.addressInfo.contact.toString().length<2||$scope.addressInfo.contact.toString().length>20)return void alertWarning("请输入2~20位的联系人姓名");if(!$scope.addressInfo.mobile||""==$scope.addressInfo.mobile)return void alertWarning("请填写手机号码");if(11!=$scope.addressInfo.mobile.toString().length)return void alertWarning("请输入11位的手机号码");var flightTime=$("#appDateTime").val();if(!flightTime||""==flightTime)return void alertWarning("请选择回程日期");if($scope.addressInfo.returnTime=flightTime,!$scope.addressInfo.returnFlightno||""==$scope.addressInfo.returnFlightno)return void alertWarning("请输入回程航班号");if(new Date(flightTime.replace(/-/g,"/"))<$scope.minDateTime)return void alertWarning("起飞时间请选择1小时后")}else{if(!$scope.addressInfo.contact||""==$scope.addressInfo.contact.toString().trim())return void alertWarning("请填写联系人姓名");if($scope.addressInfo.contact.toString().length<2||$scope.addressInfo.contact.toString().length>20)return void alertWarning("请输入2~20位的联系人姓名");if(!$scope.addressInfo.mobile||""==$scope.addressInfo.mobile)return void alertWarning("请填写手机号码");if(11!==$scope.addressInfo.mobile.toString().length)return void alertWarning("请输入11位的手机号码");if(!$scope.addressInfo.hotelName||""==$scope.addressInfo.hotelName)return void alertWarning("请输入酒店名称");if($scope.addressInfo.hotelName.length<5||$scope.addressInfo.hotelName.length>50)return void alertWarning("请输入5-50位的酒店名称");if(!$scope.addressInfo.hotelPickupDate||""==$scope.addressInfo.hotelPickupDate)return void alertWarning("请输入取货日期");if(!$scope.addressInfo.hotelTel||""==$scope.addressInfo.hotelTel)return void alertWarning("请输入酒店电话");if(!$scope.addressInfo.hotelAddress||""==$scope.addressInfo.hotelAddress.toString().trim())return void alertWarning("请填写酒店地址");if($scope.addressInfo.hotelAddress.toString().length<5||$scope.addressInfo.hotelAddress.toString().length>100)return void alertWarning("请输入5~100位的酒店地址")}$scope.search(function(){var data="";data=2==$scope.takeoverMethod?"platform=all&token="+$rootScope.tokenInfo.token+"&contact="+$scope.addressInfo.contact+"&hotelName="+$scope.addressInfo.hotelName+"&hotelPickupDate="+$scope.addressInfo.hotelPickupDate+"&hotelTel="+$scope.addressInfo.hotelTel+"&hotelAddress="+$scope.addressInfo.hotelAddress+"&mobile="+$scope.addressInfo.mobile:"platform=all&token="+$rootScope.tokenInfo.token+"&returnTime="+$("#appDateTime").val()+"&contact="+$scope.addressInfo.contact+"&returnAirportId="+$scope.addressInfo.returnAirportId+"&mobile="+$scope.addressInfo.mobile+"&returnFlightno="+$scope.addressInfo.returnFlightno,httpRequest.APIPOST("/address/add",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?($scope.step=1,$scope.$apply($scope.step),$scope.getDefaultAddress()):alertWarning(result.msg)})})},$scope.getDefaultAddress(),$scope.getOrderPrice();var startdate=new Date;startdate.setHours(startdate.getHours()+1);var m=startdate.getMinutes()%5;0!=m&&startdate.setMinutes(startdate.getMinutes()+(5-m)),startdate.setSeconds(0),startdate.setMilliseconds(0),$scope.minDateTime=startdate;var enddate=new Date;enddate.setMonth(enddate.getMonth()+6),enddate.setHours(23),enddate.setMinutes(59),enddate.setSeconds(59),enddate.setMilliseconds(999),$scope.maxDateTime=enddate,opt.datetime={dateOrder:"yymmdd",dateFormat:"yyyy-mm-dd",preset:"datetime",minDate:startdate,maxDate:enddate,stepMinute:5,onSelect:function(){$scope.time=$("#appDateTime").val(),event.stopPropagation()}};{var optDateTime=$.extend(opt.datetime,opt.Default);$.extend(opt.time,opt.Default)}$("#appDateTime").mobiscroll(optDateTime).date(optDateTime),$("#appDateTime2").mobiscroll(optDateTime).date(optDateTime),$scope.search=function(callback){if(2==$scope.takeoverMethod)return void callback();var flightNo=$scope.addressInfo.returnFlightno;if(void 0==flightNo&&(flightNo=""),flightNo.length>=2&&$("#appDateTime").val()){var data="platform=all&backFlightno="+flightNo+"&backDate="+$("#appDateTime").val();httpRequest.APIPOST("/flight/back",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.addressInfo.returnAirportId=result.result.returnAirportId,$scope.addressInfo.returnAirport=result.result.returnAirport,$scope.addressInfo.returnTime=result.result.returnTime,$scope.time||($scope.time=""),$("#appDateTime").val($("#appDateTime").val().split(" ")[0]+" "+result.result.returnTime),callback()):($scope.addressInfo.returnAirportId=-1,$scope.addressInfo.returnAirport="",alertWarning(result.msg))})}},$scope.isGoPay=!1,$scope.generateOrder=function(){if(!$scope.isGoPay){$scope.isGoPay=!0;var data="";data=2==$scope.takeoverMethod?"platform=all&token="+$rootScope.tokenInfo.token+"&contact="+$scope.defaultAddress.contact+"&pickupWay=2&hotelName="+$scope.defaultAddress.hotelName+"&hotelPhone="+$scope.defaultAddress.hotelPhone+"&hotelAddress="+$scope.defaultAddress.hotelAddress+"&pickupDate="+$scope.defaultAddress.hotelPickupDate+"&mobile="+$scope.defaultAddress.mobile+"&goodsId="+goodsId+"&quantity="+quantity:"platform=all&token="+$rootScope.tokenInfo.token+"&pickupWay=1&contact="+$scope.defaultAddress.contact+"&mobile="+$scope.defaultAddress.mobile+"&returnTime="+$scope.defaultAddress.returnDate+" "+$scope.defaultAddress.returnTime+"&returnAirportId="+$scope.defaultAddress.returnAirportId+"&returnFlightno="+$scope.defaultAddress.returnFlightno+"&goodsId="+goodsId+"&quantity="+quantity,httpRequest.APIPOST("/orderLd/add",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg||alertWarning(result.msg)})}}}),app.controller("paymentAppController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.isInCoupons=!1,$scope.id=$routeParams.id,$scope.area=parseInt($location.$$search.area)||1,$scope.user=$.parseJSON($location.$$search.user);var from=parseInt($routeParams.from)||0;$scope.products=$.parseJSON($location.$$search.goods),$scope.totalAmount=0,$scope.totalJs=0,$scope.payAmount=0;var couponsIds=[],couponsNums=[];clearAddressTemp(),$scope.addressURL=2==$scope.area?"#/address/"+$scope.id+"/2?token="+$scope.user.token:"#/address/"+$scope.id+"?token="+$scope.user.token;var isPaying=!1,goods=[];if(1==from){if($scope.products&&$scope.products.length>0)for(var i=0;i<$scope.products.length;i++)for(var j=0;j<$scope.products[i].goodsList.length;j++)if($scope.products[i].goodsList[j].checked){var good=$scope.products[i].goodsList[j];goods.push(good)}}else if(2==from){if($scope.products&&$scope.products.length>0)for(var i=0;i<$scope.products.length;i++){var good=$scope.products[i];good.price=good.promotePrice,good.id=good.goodsId,good.price=good.buyPrice,goods.push(good)}}else if($scope.products&&$scope.products.length>0)for(var i=0;i<$scope.products.length;i++){var good=$scope.products[i];good.quantity=good.num,good.img=good.smallImg,good.price=good.promotePrice,goods.push(good)}for(var goodsIdStr="",quantityStr="",i=0;i<goods.length;i++)i<goods.length-1?(goodsIdStr=goodsIdStr+goods[i].id+",",quantityStr=quantityStr+goods[i].quantity+","):(goodsIdStr+=goods[i].id,quantityStr=quantityStr+goods[i].quantity+",");if($scope.products=goods,$scope.user&&$scope.user.token&&httpRequest.APIPOST("/address/default",dataStringify("platform=all&token="+$scope.user.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?$scope.addressInfo=result.result:alertWarning(result.msg)}),getUserInfo()){var userInfo=getUserInfo();$scope.comments=userInfo.comments}var provinceId="";2==$scope.area&&$scope.addressInfo&&$scope.addressInfo.agentRegionIds&&(provinceId="&provinceId="+$scope.addressInfo.agentRegionIds.split(",")[0]);var token="";if(easybuy.isWechat){var tokenInfo=getToken();token="&token="+tokenInfo.token}httpRequest.APIPOST("/order/price",dataStringify("platform=all&category=1&goodsId="+goodsIdStr+"&quantity="+quantityStr+provinceId+token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.totalAmount=result.result,$scope.totalJs=$scope.totalAmount.js,$scope.payAmount=$scope.totalAmount.total):alert(result.msg)}),(getMobileType()==MobileTypes.iPhone||getMobileType()==MobileTypes.iPad)&&(window.onresize=function(){refixNavBottom()},window.onresize()),$scope.Payments=easybuy.Payments;for(var isChecked=!1,i=$scope.Payments.length-1;i>=0;i--)$scope.Payments[i].id!=easybuy.PaymentMethods.WechatPay||easybuy.isWechat?$scope.Payments[i].checked&&(isChecked=!0):$scope.Payments.splice(i,1);isChecked||$.each($scope.Payments,function(i,item){return item.id==easybuy.PaymentMethods.AlipayWeb?(item.checked=!0,!1):void 0}),$scope.checked=function(payment){$.each($scope.Payments,function(i,item){item.checked=!1}),payment.checked=!0},$scope.pay=function(){if(!isPaying){if(!$scope.addressInfo)return void alertWarning("请填写联系人信息");if($scope.comments&&$scope.comments.length>100)return void alertWarning("请输入100位以内的备注");if(1==$scope.area&&new Date($scope.addressInfo.returnDate+" "+$scope.addressInfo.returnTime)<new Date)return void alertWarning("起飞时间已过，请重新填写");
var payWay=null;if($.each($scope.Payments,function(i,item){return 1==item.checked?(payWay=item.id,!1):void 0}),null==payWay)return void alertWarning("请选择支付方式");if(payWay==easybuy.PaymentMethods.AlipayWallet)return void alertWarning("无法使用支付宝钱包");var goodsId="",quantity="";$.each($scope.products,function(i,product){goodsId=i==$scope.products.length-1?goodsId+product.id:goodsId+product.id+",",quantity=i==$scope.products.length-1?quantity+product.quantity:quantity+product.quantity+","});var contact=$scope.addressInfo.contact,mobile=$scope.addressInfo.mobile,returnTime="&returnTime="+$scope.addressInfo.returnDate+" "+$scope.addressInfo.returnTime;void 0==$scope.addressInfo.returnTime&&(returnTime="");var returnAirportId=parseInt($scope.addressInfo.returnAirportId),returnFlightno=$scope.addressInfo.returnFlightno,address="";address=1==$scope.area?$scope.addressInfo.returnAirport:$scope.addressInfo.detailAddress;var comment=$scope.comments?"&comments="+$scope.comments:"&comments=''";if((!$scope.user||$scope.user&&!$scope.user.token)&&($scope.user=getToken()),$scope.user&&$scope.user.token){var token=$scope.user.token,couponsIdsStr="",couponsNumsStr="";couponsIds.length>0&&couponsNums.length>0&&(couponsIdsStr="&couponsId="+couponsIds.join(","),couponsNumsStr="&couponsNum="+couponsNums.join(","));var url="platform=all&token="+token+"&contact="+contact+"&mobile="+mobile+returnTime+"&returnAirportId="+returnAirportId+"&returnFlightno="+returnFlightno+comment+"&goodsId="+goodsId+"&quantity="+quantity+couponsIdsStr+couponsNumsStr;isPaying=!0,$("#btnPay").text("下单中..."),httpRequest.APIPOST("/order/addGoodsOrder",dataStringify(url),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){if(1==from){for(var cartProducts=getCart(),tempCart=[],i=0;i<cartProducts.length;i++){for(var isHav=!1,j=0;j<$scope.products.length;j++)cartProducts[i].id==$scope.products[j].id&&(isHav=!0);isHav||tempCart.push(cartProducts[i])}setCart(tempCart)}setUserInfo(null),$("#btnPay").text("正跳转..."),payWay==easybuy.PaymentMethods.WechatPay?window.location.href=serviceUrl+"/order/pay/orderid/"+result.result.orderNum+"/amount/"+result.result.totalPrice+"/address/"+address+"/time/"+returnTime:easybuy.isWechat?window.location.hash="#/dividedPay/"+result.result.orderNum+"/"+result.result.totalPrice:window.location.href=paymentUrl+"callback=1&out_trade_no="+result.result.orderNum+"&total_fee="+result.result.totalPrice}else alertWarning(result.msg)})}else $location.path("/myProfile")}},$scope.saveUserInfo=function(){var info={};info=$scope.addressInfo,info.comments=$scope.comments,setUserInfo(info)},$scope.choseCoupon=function(){var tokenInfo=getToken(),tk="";if($scope.user&&$scope.user.token?tk=$scope.user.token:tokenInfo&&tokenInfo.token&&(tk=tokenInfo.token),!$scope.coupons){var data="platform=all&token="+tk+"&goodsId="+goodsIdStr+"&quantity="+quantityStr;showLoading(),httpRequest.APIPOST("/order/coupons",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(hideLoading(),$scope.coupons=result.result):(hideLoading(),alertWarning(result.msg))})}$scope.isInCoupons=!0},$scope.back=function(){if($scope.isInCoupons){$scope.isInCoupons=!1;for(var i=0;i<$scope.coupons.canUseList.length;i++){var isShow=$scope.coupons.canUseList[i].checked;isShow?$("#i_coupon_"+i).css("display","block"):$("#i_coupon_"+i).css("display","none")}}else history.back()},$scope.couponsNumOrigin=0,$scope.couponsJsOrigin=0,$scope.confirmCoupon=function(){var js=0,num=0;couponsIds=[],couponsNums=[];for(var i=0;i<$scope.coupons.canUseList.length;i++){var isShow="block"==$("#i_coupon_"+i).css("display");isShow?($scope.coupons.canUseList[i].checked=!0,js+=parseFloat($scope.coupons.canUseList[i].amount),num++,couponsIds.push($scope.coupons.canUseList[i].couponId),couponsNums.push(1)):$scope.coupons.canUseList[i].checked=!1}$scope.couponsNumOrigin=num,$scope.couponsJsOrigin=js,$scope.totalJs=$scope.totalAmount.js+js,$scope.payAmount=$scope.totalAmount.total-js,$scope.isInCoupons=!1},$scope.tapCoupon=function(amount,index){var isShow="block"==$("#i_coupon_"+index).css("display");isShow?$("#i_coupon_"+index).css("display","none"):$("#i_coupon_"+index).css("display","block")}}),app.controller("dividedPayController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.order={},$scope.order.orderNum=$routeParams.orderNum,$scope.order.fee=$routeParams.fee,$scope.pay=function(){window.location.href=paymentUrl+"callback=2&out_trade_no="+$scope.order.orderNum+"&total_fee="+$scope.order.fee},$scope.isWechat=easybuy.isWechat}),app.controller("successController",function($rootScope,$scope,httpRequest,analytics,$location,$window,$routeParams){var isApp="app"==$location.search().payType?!0:!1;$scope.isApp=isApp,$routeParams.ordersn&&(removeOrder(),$scope.time=$routeParams.time,$scope.address=$routeParams.address),$scope.goHome=function(){return isApp?void(window.location.href=easybuy.appActivity+"?action=17"):void $location.path("/products")},$scope.view=function(){return isApp?void(window.location.href=easybuy.appActivity+"?action=16&orderId="+$routeParams.ordersn):void $location.path("/orderDetail/"+$routeParams.ordersn+"/"+$routeParams.token)},$scope.back=function(){$location.path("/products")}}),app.controller("errorController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){var isApp="app"==$location.search().payType?!0:!1;$scope.isApp=isApp,$scope.goHome=function(){return isApp?void(window.location.href=easybuy.appActivity+"?action=17"):void $location.path("/products")},$scope.again=function(){if(isApp)return void(window.location.href=easybuy.appActivity+"?action=18");if($routeParams.orderId){var orderId=$routeParams.orderId,mobile=$routeParams.mobile;httpRequest.APIPOST("/user/h5Login",dataStringify("platform=all&account="+mobile+"&password="+mobile),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){var token=result.result;setToken({token:token,mobile:mobile}),httpRequest.APIPOST("/order/detail",dataStringify("platform=all&token="+token+"&category=1&orderId="+orderId),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){var order=result.result;$location.path("/pay/"+orderId+"/2").search({area:order.area,goods:JSON.stringify(order.goodsList)})}else alert(result.msg)})}})}else $location.path("/products")},$scope.back=function(){$location.path("/products")}}),app.controller("myPhoneController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.mobile=$routeParams.mobile||"",$scope.token=$routeParams.token||getToken().token,$scope.isSetMobile=$routeParams.mobile?!0:!1,"0"==$routeParams.mobile&&($scope.isSetMobile=!1,$scope.mobile=""),easybuy.isWechat&&!$routeParams.token&&getToken()&&getToken().token&&httpRequest.APIPOST("/mine/index",dataStringify("platform=all&token="+getToken().token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var userInfo=result.result;$scope.mobile=userInfo.mobile,$scope.mobile&&($scope.isSetMobile=!0)}else alertWarning(result.msg)}),$scope.focus=function(){$("#myPhoneNumber").focus()},$scope.back=function(){$location.path("/myProfile")},$scope.setPhone=function(){if(!$scope.mobile||$scope.mobile.toString().length<9||$scope.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");if(!$scope.code||$scope.code.toString().length<4||$scope.code.toString().length>8)return void alertWarning("请输入验证码");var data="platform=all&token="+$scope.token+"&mobile="+$scope.mobile+"&code="+$scope.code;$scope.wait=0,showLoading(),httpRequest.APIPOST("/user/bindMobile",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){alertWarning("手机号设置成功");var temp=getToken();if(temp&&(temp.mobile=$scope.mobile,setToken(temp)),$location.$$search&&$location.$$search.user&&$location.$$search.user.openId){var arr=$location.$$search.state.split("-");if("orderDetail"==arr[0])return void $location.path("/orderDetail/"+arr[1]+"/"+$scope.token).search(user);if(arr.length<2)return void $location.path("/"+$location.$$search.state).search($location.$$search.user);if(2==arr.length)return void $location.path("/"+arr[0]+"/"+arr[1]).search($location.$$search.user);if(3==arr.length)return void $location.path("/"+arr[0]+"/"+arr[1]+"/"+arr[2]).search($location.$$search.user)}else $location.path("/myProfile")}else alertWarning(result.msg)})},$scope.wait=60;var time=function(){0==$scope.wait?($scope.wait=60,$("#codeClock").css("display","none")):($scope.wait--,$scope.$apply($scope.wait),setTimeout(function(){time()},1e3))};$scope.getCheckCode=function(){if($scope.mobile.toString().length<9||$scope.mobile.toString().length>13)return void alertWarning("请输入9~13位的手机号码");$("#codeClock").css("display","inline-block"),time();var data="platform=all&type=3&mobile="+$scope.mobile;httpRequest.APIPOST("/sms/getVerifyCode",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success||alertWarning(result.msg)})}}),app.controller("myCouponController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.token=$routeParams.token?$routeParams.token:getToken()?getToken().token:"";var from=$location.search()&&$location.search().from?$location.search().from:"";if(easybuy.isWechat&&!$routeParams.token&&"activity"==from){var t=getToken();if($scope.token=t.token,!t.mobile||t.mobile&&t.mobile.length<6)return void $location.path("/wechatOauth/myCoupon").search({from:from})}if($scope.token){var data="platform=all&token="+$scope.token;showLoading(),httpRequest.APIPOST("/coupons/mine",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(hideLoading(),$scope.coupons=result.result):(hideLoading(),alert(result.msg))})}else $location.path("/myProfile");$scope.back=function(){$location.search()&&$location.search().from?history.back():$location.path("/myProfile")}}),app.controller("myIncomeController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){$scope.step=1,$scope.withDraw=function(t){if(0===t)return void($scope.step=2);var account=$scope.account||"",name=$scope.name||"",mobile=$scope.mobile||"";if(!account)return void alertWarning("请输入支付宝账号");if(!name)return void alertWarning("请输入支付宝姓名");if(!mobile||mobile&&mobile.length<1)return void alertWarning("请输入手机号");if(11!=mobile.length)return void alertWarning("请输入11位的手机号码");var data="platform=all&token="+$rootScope.tokenInfo.token+"&account="+account+"&name="+name+"&mobile="+mobile;httpRequest.APIPOST("/ldIncome/apply",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(alertWarning("申请成功，请等待审核"),$scope.step=1,$scope.getIncomeList(1),$scope.getIncomeList(2)):alertWarning(result.msg)})},$scope.back=function(){return $scope.step>1?void($scope.step=1):void $location.path("/myProfile")},$scope.incomeList1=[],$scope.incomeList2=[],$scope.incomeList3=[],$scope.getIncomeList=function(s){httpRequest.APIPOST("/ldIncome/listByStatus",dataStringify("platform=all&token="+$rootScope.tokenInfo.token+"&status="+s),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(1==s&&($scope.incomeList1=result.result),2==s&&($scope.incomeList2=result.result),3==s&&($scope.incomeList3=result.result)):alertWarning(result.msg)})},$scope.getIncomeList(1),$scope.getIncomeList(2),$scope.getIncomeList(3)}),app.controller("myWishController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){$scope.step=1,$scope.saveWish=function(wish){if(!wish)return void alertWarning("请输入心愿产品名称");if(!wish.name)return void alertWarning("请输入心愿产品名称");if(!wish.feature)return void alertWarning("请输入500位以内的产品特点");if(wish.name.length<5||wish.name.length>100)return void alertWarning("请输入5-100位以内的心愿产品名称");if(!wish.feature)return void alertWarning("请输入500位以内的产品特点");if(wish.feature.length>500)return void alertWarning("请输入500位以内的产品特点");wish.link=wish.link?wish.link:"";var data="platform=all&token="+$rootScope.tokenInfo.token+"&name="+wish.name+"&link="+wish.link+"&feature="+wish.feature,apiUrl="/ldWish/add";wish.id&&(apiUrl="/ldWish/edit",data="platform=all&token="+$rootScope.tokenInfo.token+"&name="+wish.name+"&link="+wish.link+"&feature="+wish.feature+"&id="+wish.id),httpRequest.APIPOST(apiUrl,dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(alertWarning("提交成功！"),$scope.getWishList(),$scope.step=2):alertWarning(result.msg)})},$scope.wishNow=function(){$scope.step=2},$scope.editWish=function(id,index){$scope.wish=$scope.wishList[index],$scope.step=2},$scope.back=function(){return $scope.step>1?void($scope.step=1):void $location.path("/myProfile")},$scope.getWishList=function(){httpRequest.APIPOST("/ldWish/list",dataStringify("platform=all&token="+$rootScope.tokenInfo.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?$scope.wishList=result.result:alertWarning(result.msg)})},$scope.getWishList()}),app.controller("myController",function($rootScope,$scope,httpRequest,$http,dataStringify,analytics,$location,$window,$routeParams){function callback(u){var user=u?u:$location.$$search;if($scope.user=user,user&&user.openId){var source=user.source,data="platform=all&openid="+user.openId+"&nickname="+user.nickname+"&gender=0&avatar="+user.headimgurl+"&source="+source+"&channel=H5&appVersion="+easybuy.version;httpRequest.APIPOST("/user/thirdLogin",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.isLogin=!0,$scope.user=result.result,$scope.user.openId=user.openId,$scope.user.source=user.source,$scope.user.nickname=user.nickname,$scope.user.headimgurl=user.headimgurl,$scope.user.bind=1,null==$scope.user.mobile&&($scope.user.mobile="0"),$scope.user.mobile&&"0"!=$scope.user.mobile||$location.path("/myPhone/0/"+$scope.user.token).search({user:$scope.user,state:"myProfile"}),setToken($scope.user),$scope.isNeedBind=!0,$scope.$apply($scope.isNeedBind),$scope.$apply($scope.user)):alert(result.msg)})}else $scope.user=getToken(),$scope.user?($scope.isLogin=!0,(!$scope.user.mobile||$scope.user.mobile&&$scope.user.mobile.length<6)&&($scope.user.mobile=0)):($scope.isLogin=!1,$scope.user={}),$scope.$apply($scope.user),$scope.$apply($scope.isLogin)}$rootScope.$on("CtrlUserModule",function(event,isLogin){$scope.isLogin=isLogin});var from=$routeParams.from||"";$scope.isNeedBind=!0,$scope.from=from;var loginFrom=1;$scope.isLogin=!0,$scope.isShowLogoutBtn=!easybuy.isWechat,easybuy.isWechat||(getToken()?($scope.user=getToken(),$scope.isLogin=!0,$scope.isNeedBind=0==$scope.user.bind||"0"==$scope.user.bind||$scope.user.source&&4==$scope.user?!1:!0,loginFrom=$scope.user.source):$scope.isLogin=!1),$scope.forgot=function(){$location.path("/forgot")},$scope.incomeAmount=$rootScope.tokenInfo?$rootScope.tokenInfo.incomeAmount||0:0,$scope.myInfo=function(){$location.path("/myInfo")},$scope.login=function(){var u=$scope.username,p=$scope.password;if(!u||u&&u.length<1||!p||p&&p.length<1)return void alertWarning("请输入手机号/密码");if(11!=u.length||p.length<4||p.length>20)return void alertWarning("请输入正确的手机号或密码");var data="platform=all&account="+u+"&password="+p+"&category=2";httpRequest.APIPOST("/user/login/ld",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var token=result.result.token,data2="platform=all&token="+token;httpRequest.APIPOST("/mine/index",dataStringify(data2),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var userInfo=result.result;if($scope.isLogin=!0,$scope.user={},$scope.user.token=token,$scope.user.openId="0",$scope.user.source=4,$scope.user.nickname=userInfo.nickname,$scope.user.headimgurl=userInfo.avatar,$scope.user.mobile=userInfo.mobible,$scope.user.category=userInfo.category,$scope.user.realName=userInfo.realName,$scope.user.incomeAmount=userInfo.incomeAmount,$scope.incomeAmount=userInfo.incomeAmount,$scope.user.bind=0,$scope.isNeedBind=!1,setToken($scope.user),"/myProfile"!=$location.path())return void($rootScope.isRootLogin=!0);from&&($location.path("/oauth2/"+$scope.user.openId+"/"+from).search({openId:$scope.user.openId,nickname:userInfo.nickname,headimgurl:userInfo.avatar,source:4,bind:$scope.user.bind}),$scope.$apply($location))}else alertWarning(result.msg)})}else alertWarning(result.msg)}),loginFrom=4},$scope.register=function(){$location.path("/register")},$scope.back=function(){$location.path("/products")},easybuy.isWechat&&callback(),$scope.validNum=function(){$scope.username=validInteger($scope.username)},$scope.drawProfie=function(){$(".my-profile").css("height",$(window).width()*(640/242)+"px")},$scope.drawProfie(),$(window).resize(function(){$scope.drawProfie()})}),app.controller("myInfoController",function($rootScope,$scope,httpRequest,$http,dataStringify,analytics,$location){$scope.step=1,$scope.updatePassword=function(){$scope.step=3},$scope.updateName=function(){$scope.step=2};var loginFrom=1;$scope.logout=function(){var arrButton=["取消","确定"];openDialog("您是否确认退出？",null,arrButton,null,function(r){if(r){if(4==loginFrom){var data="platform=all&token="+$scope.user.token;httpRequest.APIPOST("/user/logout",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.user={},removeToken(),$scope.isLogin=!1,$scope.$apply($scope.isLogin),$scope.$apply($scope.user),location.href=location.href.split("?")[0]):alertWarning(result.msg)})}$scope.user={},removeToken(),$scope.isLogin=!1,$rootScope.isRootLogin=!1,$scope.$apply($scope.isLogin),$scope.$apply($scope.user),$rootScope.$apply($rootScope.isRootLogin),$location.path("/myProfile"),$scope.$apply($location)}})},$scope.username=$rootScope.tokenInfo.realName,$scope.saveName=function(){var name=$scope.username;if(!name||name&&name.length<1)return void alertWarning("请输入您的真实姓名");var data="platform=all&token="+$rootScope.tokenInfo.token+"&realname="+name;httpRequest.APIPOST("/user/updateRealname",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){$rootScope.tokenInfo.realName=name;var tokenInfo=getToken();tokenInfo.realName=name,setToken(tokenInfo),alertWarning("姓名修改成功。"),$scope.step=1}else alertWarning(result.msg)})},$scope.savePassword=function(){var password=$scope.password,newPassword=$scope.newpassword,newPassword2=$scope.newpassword2;if(!password||password.length<6||password.length>20)return void alertWarning("请输入正确的旧密码");if(!newPassword||newPassword.length<6||newPassword.length>20)return void alertWarning("请输入6~20位的密码");if(!newPassword2||newPassword2.length<6||newPassword2.length>20)return void alertWarning("请输入6~20位的密码");if(newPassword!=newPassword2)return void alertWarning("新密码和确认密码不一致");var data="platform=all&token="+$rootScope.tokenInfo.token+"&oldPassword="+password+"&newPassword="+newPassword;httpRequest.APIPOST("/user/updatePassword",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(alertWarning("密码修改成功。"),$scope.step=1):alertWarning(result.msg)})},$scope.save=function(){2==$scope.step&&$scope.saveName(),3==$scope.step&&$scope.savePassword()},$scope.back=function(){return $scope.step>1?void($scope.step=1):void $location.path("/myProfile")}}),app.controller("registerController",function($rootScope,$scope,httpRequest,$http,dataStringify,analytics,$location){$scope.register=function(){var u=$scope.username,c=$scope.code,p=$scope.password,ic=$scope.inviteCode,name=$scope.name;if(!u||u&&u.length<1)return void alertWarning("请输入手机号");if(11!=u.length)return void alertWarning("请输入11位的手机号码");if(!c||c.toString().length<4||c.toString().length>8)return void alertWarning("请输入验证码");if(!p||p.length<6||p.length>20)return void alertWarning("请输入6~20位的密码");if(!ic||ic.length<7||ic.length>20)return void alertWarning("请输入7位的邀请码");if(!name||name.length<6||name.length>20)return void alertWarning("请输入您的真实姓名");$scope.wait=0;var data="platform=all&mobile="+u+"&password="+p+"&code="+c+"&inviteCode="+ic+"&realname="+name;httpRequest.APIPOST("/user/register",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var token=result.result.token,data2="platform=all&token="+token;httpRequest.APIPOST("/mine/index",dataStringify(data2),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var userInfo=result.result;$scope.user={},$scope.user.token=token,$scope.user.openId="0",$scope.user.source=4,$scope.user.nickname=userInfo.nickname,$scope.user.headimgurl=userInfo.avatar,$scope.user.mobile=userInfo.mobible,$scope.user.bind=userInfo.bind||0,$scope.user.category=userInfo.category,$scope.user.realName=userInfo.realName,$scope.user.incomeAmount=userInfo.incomeAmount,setToken($scope.user),$location.path("/myProfile")}else alertWarning(result.msg)})}else alertWarning(result.msg)})},$scope.back=function(){$location.path("/myProfile")},$scope.validNum=function(){$scope.username=validInteger($scope.username)},$scope.wait=60;var time=function(){0==$scope.wait?($scope.wait=60,$("#codeClock").css("display","none")):($scope.wait--,$scope.$apply($scope.wait),setTimeout(function(){time()},1e3))};$scope.getCheckCode=function(){if(!$scope.username||$scope.username.toString().length<9||$scope.username.toString().length>13)return void alertWarning("请输入9~13位的手机号码");$("#codeClock").css("display","inline-block"),time();var data="platform=all&type=1&mobile="+$scope.username;httpRequest.APIPOST("/sms/getVerifyCode",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success||alertWarning(result.msg)})}}),app.controller("forgotController",function($rootScope,$scope,httpRequest,$http,dataStringify,analytics,$location){$scope.register=function(){var u=$scope.username,c=$scope.code,p=$scope.password;if(!u||u&&u.length<1)return void alertWarning("请输入手机号");if(11!=u.length)return void alertWarning("请输入11位的手机号码");if(!c||c.toString().length<4||c.toString().length>8)return void alertWarning("请输入验证码");if(!p||p.length<4||p.length>20)return void alertWarning("请输入4~20位的密码");$scope.wait=0;var data="platform=all&mobile="+u+"&password="+p+"&code="+c;httpRequest.APIPOST("/user/password",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(alertWarning("新密码设置成功！"),$location.path("/products")):alertWarning(result.msg)})},$scope.back=function(){$location.path("/myProfile")},$scope.validNum=function(){$scope.username=validInteger($scope.username)},$scope.wait=60;var time=function(){0==$scope.wait?($scope.wait=60,$("#codeClock").css("display","none")):($scope.wait--,$scope.$apply($scope.wait),setTimeout(function(){time()},1e3))};$scope.getCheckCode=function(){if(!$scope.username||$scope.username.toString().length<9||$scope.username.toString().length>13)return void alertWarning("请输入9~13位的手机号码");$("#codeClock").css("display","inline-block"),time();var data="platform=all&type=2&mobile="+$scope.username;httpRequest.APIPOST("/sms/getVerifyCode",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success||alertWarning(result.msg)})}});